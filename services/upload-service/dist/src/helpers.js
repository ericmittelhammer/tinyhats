"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.fileExt = void 0;
exports.push2RDS = push2RDS;
exports.uniqueId = void 0;
exports.uploadFile = uploadFile;

var _awsSdk = require("aws-sdk");

var _generateUniqueId = require("generate-unique-id");

var _mysql = require("mysql");

var _winston = require("winston");

var _winstonEnricher = require("@newrelic/winston-enricher");

const logger = _winston.createLogger({
  level: 'info',
  exitOnError: false,
  transports: [new _winston.transports.Console({
    handleExceptions: true,
    handleRejections: true
  })],
  format: _winston.format.combine(_winston.format((info, opts) => Object.assign(info, {
    module: __filename
  }))(), _winstonEnricher(), _winston.format.json())
});

const ID = process.env.S3_ID;
const SECRET = process.env.S3_SECRET;
const BUCKET_NAME = 'tinyhats';
const HOST = process.env.HOST;
const PASSWORD = process.env.PASSWORD;

const con = _mysql.createConnection({
  host: HOST,
  port: '3306',
  user: "admin",
  password: PASSWORD
});

const s3 = new _awsSdk.S3({
  accessKeyId: ID,
  secretAccessKey: SECRET
});

async function uploadFile(fileName, fileContent) {
  let link = "";
  let key = fileName; // Setting up S3 upload parameters

  const params = {
    Bucket: BUCKET_NAME,
    Key: key,
    // File name you want to save as in S3
    Body: fileContent
  }; // Uploading files to the bucket

  s3.upload(params, (err, data) => {
    if (err) {
      throw err;
    }

    link = data.Location;
    logger.info(`File uploaded successfully. ${link}`);
  });
  return `https://${BUCKET_NAME}.s3.amazonaws.com/${key}`;
}

;

const fileExt = ext => {
  if (ext == "image/png") {
    return '.png';
  } else if (ext == "image/jpeg") {
    return '.jpeg';
  } else if (ext == "image/jpg") {
    return '.jpg';
  } else {
    process.exit();
  }
};

exports.fileExt = fileExt;

const uniqueId = () => {
  const id = _generateUniqueId({
    length: 16
  }); // generate length 16 random file name


  return id;
};

exports.uniqueId = uniqueId;

async function push2RDS(key, ext, name, link) {
  con.connect(function (err) {
    con.query(`INSERT INTO main.images (keyId, fileName, url, description, approve) VALUES ('${key}', '${key + ext}', '${link}', '${name}', 'false')`, function (err, result, fields) {
      if (err) logger.error(err);
      if (result) logger.info({
        key: key,
        fileName: key + ext,
        url: link,
        description: name,
        approve: "false"
      });
      if (fields) logger.info(fields);
    }); // connect to mysql and push data
  });
  return {
    key: key,
    fileName: key + ext,
    url: link,
    description: name,
    approve: "false"
  };
}

;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsIndpbnN0b24iLCJjcmVhdGVMb2dnZXIiLCJsZXZlbCIsImV4aXRPbkVycm9yIiwidHJhbnNwb3J0cyIsIkNvbnNvbGUiLCJoYW5kbGVFeGNlcHRpb25zIiwiaGFuZGxlUmVqZWN0aW9ucyIsImZvcm1hdCIsImNvbWJpbmUiLCJpbmZvIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsIm1vZHVsZSIsIl9fZmlsZW5hbWUiLCJuZXdyZWxpY0Zvcm1hdHRlciIsImpzb24iLCJJRCIsInByb2Nlc3MiLCJlbnYiLCJTM19JRCIsIlNFQ1JFVCIsIlMzX1NFQ1JFVCIsIkJVQ0tFVF9OQU1FIiwiSE9TVCIsIlBBU1NXT1JEIiwiY29uIiwibXlzcWwiLCJjcmVhdGVDb25uZWN0aW9uIiwiaG9zdCIsInBvcnQiLCJ1c2VyIiwicGFzc3dvcmQiLCJzMyIsIkFXUyIsIlMzIiwiYWNjZXNzS2V5SWQiLCJzZWNyZXRBY2Nlc3NLZXkiLCJ1cGxvYWRGaWxlIiwiZmlsZU5hbWUiLCJmaWxlQ29udGVudCIsImxpbmsiLCJrZXkiLCJwYXJhbXMiLCJCdWNrZXQiLCJLZXkiLCJCb2R5IiwidXBsb2FkIiwiZXJyIiwiZGF0YSIsIkxvY2F0aW9uIiwiZmlsZUV4dCIsImV4dCIsImV4aXQiLCJ1bmlxdWVJZCIsImlkIiwiZ2VuZXJhdGVVbmlxdWVJZCIsImxlbmd0aCIsInB1c2gyUkRTIiwibmFtZSIsImNvbm5lY3QiLCJxdWVyeSIsInJlc3VsdCIsImZpZWxkcyIsImVycm9yIiwidXJsIiwiZGVzY3JpcHRpb24iLCJhcHByb3ZlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUEsTUFBTUEsTUFBTSxHQUFHQyxRQUFPLENBQUNDLFlBQVIsQ0FBcUI7QUFDaENDLEVBQUFBLEtBQUssRUFBRSxNQUR5QjtBQUVoQ0MsRUFBQUEsV0FBVyxFQUFFLEtBRm1CO0FB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ayc7XG5pbXBvcnQgZ2VuZXJhdGVVbmlxdWVJZCBmcm9tICdnZW5lcmF0ZS11bmlxdWUtaWQnXG5pbXBvcnQgbXlzcWwgZnJvbSAnbXlzcWwnXG5cbmltcG9ydCB3aW5zdG9uIGZyb20gJ3dpbnN0b24nXG5pbXBvcnQgbmV3cmVsaWNGb3JtYXR0ZXIgZnJvbSAnQG5ld3JlbGljL3dpbnN0b24tZW5yaWNoZXInXG5cbmNvbnN0IGxvZ2dlciA9IHdpbnN0b24uY3JlYXRlTG9nZ2VyKHtcbiAgICBsZXZlbDogJ2luZm8nLFxuICAgIGV4aXRPbkVycm9yOiBmYWxzZSxcbiAgICB0cmFuc3BvcnRzOiBbXG4gICAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoe1xuICAgICAgICBoYW5kbGVFeGNlcHRpb25zOiB0cnVlLFxuICAgICAgICBoYW5kbGVSZWplY3Rpb25zOiB0cnVlXG4gICAgICB9KVxuICAgIF0sXG4gICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgICAgICB3aW5zdG9uLmZvcm1hdCgoaW5mbywgb3B0cykgPT4gT2JqZWN0LmFzc2lnbihpbmZvLCB7bW9kdWxlOiBfX2ZpbGVuYW1lfSkpKCksXG4gICAgICAgIG5ld3JlbGljRm9ybWF0dGVyKCksXG4gICAgICAgIHdpbnN0b24uZm9ybWF0Lmpzb24oKVxuICAgIClcbiAgfSk7XG5cbmNvbnN0IElEID0gcHJvY2Vzcy5lbnYuUzNfSUQ7XG5jb25zdCBTRUNSRVQgPSBwcm9jZXNzLmVudi5TM19TRUNSRVQ7XG5jb25zdCBCVUNLRVRfTkFNRSA9ICd0aW55aGF0cyc7XG5cbmNvbnN0IEhPU1QgPSBwcm9jZXNzLmVudi5IT1NUO1xuY29uc3QgUEFTU1dPUkQgPSBwcm9jZXNzLmVudi5QQVNTV09SRDtcblxuY29uc3QgY29uID0gbXlzcWwuY3JlYXRlQ29ubmVjdGlvbih7XG4gICAgaG9zdDogSE9TVCxcbiAgICBwb3J0OiAnMzMwNicsXG4gICAgdXNlcjogXCJhZG1pblwiLFxuICAgIHBhc3N3b3JkOiBQQVNTV09SRCxcbn0pO1xuXG5jb25zdCBzMyA9IG5ldyBBV1MuUzMoe1xuICAgIGFjY2Vzc0tleUlkOiBJRCxcbiAgICBzZWNyZXRBY2Nlc3NLZXk6IFNFQ1JFVFxufSk7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGxvYWRGaWxlKGZpbGVOYW1lLCBmaWxlQ29udGVudCkge1xuICAgIGxldCBsaW5rID0gXCJcIlxuICAgIGxldCBrZXkgPSBmaWxlTmFtZVxuICAgIC8vIFNldHRpbmcgdXAgUzMgdXBsb2FkIHBhcmFtZXRlcnNcbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICAgIEJ1Y2tldDogQlVDS0VUX05BTUUsXG4gICAgICAgIEtleToga2V5LCAvLyBGaWxlIG5hbWUgeW91IHdhbnQgdG8gc2F2ZSBhcyBpbiBTM1xuICAgICAgICBCb2R5OiBmaWxlQ29udGVudFxuICAgIH07XG5cbiAgICAvLyBVcGxvYWRpbmcgZmlsZXMgdG8gdGhlIGJ1Y2tldFxuICAgIHMzLnVwbG9hZChwYXJhbXMsIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9XG4gICAgICAgIGxpbmsgPSBkYXRhLkxvY2F0aW9uXG4gICAgICAgIGxvZ2dlci5pbmZvKGBGaWxlIHVwbG9hZGVkIHN1Y2Nlc3NmdWxseS4gJHtsaW5rfWApO1xuICAgIH0pO1xuICAgIHJldHVybiBgaHR0cHM6Ly8ke0JVQ0tFVF9OQU1FfS5zMy5hbWF6b25hd3MuY29tLyR7a2V5fWBcbn07XG5cbmV4cG9ydCBjb25zdCBmaWxlRXh0ID0gKGV4dCkgPT4ge1xuICAgIGlmIChleHQgPT0gXCJpbWFnZS9wbmdcIikge1xuICAgICAgICByZXR1cm4gJy5wbmcnXG4gICAgfSBlbHNlIGlmIChleHQgPT0gXCJpbWFnZS9qcGVnXCIpIHtcbiAgICAgICAgcmV0dXJuICcuanBlZydcbiAgICB9IGVsc2UgaWYgKGV4dCA9PSBcImltYWdlL2pwZ1wiKSB7XG4gICAgICAgIHJldHVybiAnLmpwZydcbiAgICB9IGVsc2Uge1xuICAgICAgICBwcm9jZXNzLmV4aXQoKVxuICAgIH1cbn1cblxuZXhwb3J0IGNvbnN0IHVuaXF1ZUlkID0gKCkgPT4ge1xuICAgIGNvbnN0IGlkID0gZ2VuZXJhdGVVbmlxdWVJZCh7XG4gICAgICAgIGxlbmd0aDogMTZcbiAgICB9KTtcbiAgICAvLyBnZW5lcmF0ZSBsZW5ndGggMTYgcmFuZG9tIGZpbGUgbmFtZVxuXG4gICAgcmV0dXJuIGlkXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwdXNoMlJEUyhrZXksIGV4dCwgbmFtZSwgbGluaykge1xuICAgIGNvbi5jb25uZWN0KGZ1bmN0aW9uKGVycikge1xuICAgICAgICBjb24ucXVlcnkoYElOU0VSVCBJTlRPIG1haW4uaW1hZ2VzIChrZXlJZCwgZmlsZU5hbWUsIHVybCwgZGVzY3JpcHRpb24sIGFwcHJvdmUpIFZBTFVFUyAoJyR7a2V5fScsICcke2tleSArIGV4dH0nLCAnJHtsaW5rfScsICcke25hbWV9JywgJ2ZhbHNlJylgLCBmdW5jdGlvbihlcnIsIHJlc3VsdCwgZmllbGRzKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSBsb2dnZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIGxvZ2dlci5pbmZvKHtrZXk6IGtleSwgZmlsZU5hbWU6IGtleSArIGV4dCwgdXJsOiBsaW5rLCBkZXNjcmlwdGlvbjogbmFtZSwgYXBwcm92ZTogXCJmYWxzZVwifSk7XG4gICAgICAgICAgICBpZiAoZmllbGRzKSBsb2dnZXIuaW5mbyhmaWVsZHMpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gY29ubmVjdCB0byBteXNxbCBhbmQgcHVzaCBkYXRhXG4gICAgfSk7XG4gICAgcmV0dXJuIHtrZXk6IGtleSwgZmlsZU5hbWU6IGtleSArIGV4dCwgdXJsOiBsaW5rLCBkZXNjcmlwdGlvbjogbmFtZSwgYXBwcm92ZTogXCJmYWxzZVwifVxufTsiXX0=