"use strict";

var _newrelic = require("newrelic");

var _express = require("express");

var _multer = require("multer");

var _url = require("url");

var _winston = require("winston");

var _winstonEnricher = require("@newrelic/winston-enricher");

var _helpers = require("./src/helpers.js");

const logger = _winston.createLogger({
  level: 'info',
  exitOnError: false,
  transports: [new _winston.transports.Console({
    handleExceptions: true,
    handleRejections: true
  })],
  format: _winston.format.combine(_winston.format((info, opts) => Object.assign(info, {
    module: __filename
  }))(), _winstonEnricher(), _winston.format.json())
});

const upload = _multer();

const app = _express();

var router = _express.Router();

const PORT = 1337; // for testing locally: node -r dotenv/config index.js  
// https://stackoverflow.com/questions/28305120/differences-between-express-router-and-app-get

app.use(function (req, res, next) {
  logger.info(`requested: ${req.url}`);
  next();
});
app.use('/', router);
app.listen(PORT, () => {
  logger.info(`Hats Service started on port ${PORT}`);
});

async function numHats(req, res, next) {
  next();
}

router.get('/list', async function list(req, res) {
  logger.info("Getting hats");
  let data = await (0, _helpers.getHatData)();
  logger.info(`fetched ${data.length} hats`);

  _newrelic.addCustomAttribute('hatListSize', data.length);

  res.send(data);
});

async function applyHats(req, res, next) {
  let numHats = 1;

  if (req.query.number != undefined) {
    numHats = req.query.number;
  }

  let hat = null;

  if (req.query.style == undefined) {
    _newrelic.addCustomAttribute('random', true);

    hat = await (0, _helpers.getRandomHat)();
  } else {
    _newrelic.addCustomAttribute('random', false);

    hat = await (0, _helpers.getSpecificHat)(req.query.style);
  }

  if (hat == null) {
    logger.info(`Hat style ${req.query.style} does not exist`);
    return res.status(400).send({
      message: 'This hat style does not exist! If you want this style - try submitting it'
    });
  }

  logger.info(`Going to apply ${numHats} ${req.query.style} hat(s) to image`);
  let b64Result = await (0, _helpers.requestManipulate)(req.face, hat, numHats);
  res.send(b64Result);
}

router.get('/hatme', async function hatmeGet(req, res, next) {
  let qs = _url.parse(req.url).query;

  _newrelic.addCustomAttribute('qs', qs);

  _newrelic.addCustomAttribute('customFace', false);

  req.face = await (0, _helpers.defaultBoss)();
  await applyHats(req, res, next);
});
router.post('/hatme', upload.any(), async function hatmePost(req, res, next) {
  let qs = _url.parse(req.url).query;

  _newrelic.addCustomAttribute('qs', qs);

  _newrelic.addCustomAttribute('customFace', true);

  req.face = req.files[0].buffer;
  await applyHats(req, res, next);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsIndpbnN0b24iLCJjcmVhdGVMb2dnZXIiLCJsZXZlbCIsImV4aXRPbkVycm9yIiwidHJhbnNwb3J0cyIsIkNvbnNvbGUiLCJoYW5kbGVFeGNlcHRpb25zIiwiaGFuZGxlUmVqZWN0aW9ucyIsImZvcm1hdCIsImNvbWJpbmUiLCJpbmZvIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsIm1vZHVsZSIsIl9fZmlsZW5hbWUiLCJuZXdyZWxpY0Zvcm1hdHRlciIsImpzb24iLCJ1cGxvYWQiLCJtdWx0ZXIiLCJhcHAiLCJleHByZXNzIiwicm91dGVyIiwiUm91dGVyIiwiUE9SVCIsInVzZSIsInJlcSIsInJlcyIsIm5leHQiLCJ1cmwiLCJsaXN0ZW4iLCJudW1IYXRzIiwiZ2V0IiwibGlzdCIsImRhdGEiLCJsZW5ndGgiLCJuZXdyZWxpYyIsImFkZEN1c3RvbUF0dHJpYnV0ZSIsInNlbmQiLCJhcHBseUhhdHMiLCJxdWVyeSIsIm51bWJlciIsInVuZGVmaW5lZCIsImhhdCIsInN0eWxlIiwic3RhdHVzIiwibWVzc2FnZSIsImI2NFJlc3VsdCIsImZhY2UiLCJoYXRtZUdldCIsInFzIiwicGFyc2UiLCJwb3N0IiwiYW55IiwiaGF0bWVQb3N0IiwiZmlsZXMiLCJidWZmZXIiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBbUJBOztBQWpCQSxNQUFNQSxNQUFNLEdBQUdDLFFBQU8sQ0FBQ0MsWUFBUixDQUFxQjtBQUNoQ0MsRUFBQUEsS0FBSyxFQUFFLE1BRHlCO0FBRWhDQyxFQUFBQSxXQUFXLEVBQUUsS0FGbUI7QUFHaENDLEVBQUFBLFVBQVUsRUFBRSxDQUNWLElBQUlKLFFBQU8sQ0FBQ0ksVUFBUixDQUFtQkMsT0FBdkIsQ0FBK0I7QUFDN0JDLElBQUFBLGdCQUFnQixFQUFFLElBRFc7QUFFN0JDLElBQUFBLGdCQUFnQixFQUFFO0FBRlcsR0FBL0IsQ0FE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QUFDQUosRUFBQUEsU0FBUSxDQUFDQyxrQkFBVCxDQUE0QixJQUE1QixFQUFrQ2EsRUFBbEM7O0FBQ0FkLEVBQUFBLFNBQVEsQ0FBQ0Msa0JBQVQsQ0FBNEIsWUFBNUIsRUFBMEMsSUFBMUM7O0FBQ0FYLEVBQUFBLEdBQUcsQ0FBQ3NCLElBQUosR0FBV3RCLEdBQUcsQ0FBQzZCLEtBQUosQ0FBVSxDQUFWLEVBQWFDLE1BQXhCO0FBQ0EsUUFBTWpCLFNBQVMsQ0FBQ2IsR0FBRCxFQUFNQyxHQUFOLEVBQVdDLElBQVgsQ0FBZjtBQUNILENBTkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbmV3cmVsaWMgZnJvbSAnbmV3cmVsaWMnXG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJ1xuaW1wb3J0IG11bHRlciBmcm9tICdtdWx0ZXInXG5pbXBvcnQgdXJsIGZyb20gJ3VybCdcbmltcG9ydCB3aW5zdG9uIGZyb20gJ3dpbnN0b24nXG5pbXBvcnQgbmV3cmVsaWNGb3JtYXR0ZXIgZnJvbSAnQG5ld3JlbGljL3dpbnN0b24tZW5yaWNoZXInXG5cbmNvbnN0IGxvZ2dlciA9IHdpbnN0b24uY3JlYXRlTG9nZ2VyKHtcbiAgICBsZXZlbDogJ2luZm8nLFxuICAgIGV4aXRPbkVycm9yOiBmYWxzZSxcbiAgICB0cmFuc3BvcnRzOiBbXG4gICAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoe1xuICAgICAgICBoYW5kbGVFeGNlcHRpb25zOiB0cnVlLFxuICAgICAgICBoYW5kbGVSZWplY3Rpb25zOiB0cnVlXG4gICAgICB9KVxuICAgIF0sXG4gICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgICAgICB3aW5zdG9uLmZvcm1hdCgoaW5mbywgb3B0cykgPT4gT2JqZWN0LmFzc2lnbihpbmZvLCB7bW9kdWxlOiBfX2ZpbGVuYW1lfSkpKCksXG4gICAgICAgIG5ld3JlbGljRm9ybWF0dGVyKCksXG4gICAgICAgIHdpbnN0b24uZm9ybWF0Lmpzb24oKVxuICAgIClcbiAgfSk7XG5cblxuaW1wb3J0IHsgZGVmYXVsdEJvc3MsIGdldFJhbmRvbUhhdCwgZ2V0U3BlY2lmaWNIYXQsIHJlcXVlc3RNYW5pcHVsYXRlLCBnZXRIYXREYXRhIH0gZnJvbSAnLi9zcmMvaGVscGVycy5qcydcbmNvbnN0IHVwbG9hZCA9IG11bHRlcigpXG5jb25zdCBhcHAgPSBleHByZXNzKClcbnZhciByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuY29uc3QgUE9SVCA9IDEzMzdcblxuLy8gZm9yIHRlc3RpbmcgbG9jYWxseTogbm9kZSAtciBkb3RlbnYvY29uZmlnIGluZGV4LmpzICBcbi8vIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzI4MzA1MTIwL2RpZmZlcmVuY2VzLWJldHdlZW4tZXhwcmVzcy1yb3V0ZXItYW5kLWFwcC1nZXRcblxuYXBwLnVzZShmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIGxvZ2dlci5pbmZvKGByZXF1ZXN0ZWQ6ICR7cmVxLnVybH1gKTtcbiAgICBuZXh0KCk7XG59KVxuXG5hcHAudXNlKCcvJywgcm91dGVyKVxuXG5hcHAubGlzdGVuKFBPUlQsICgpID0+IHtcbiAgICBsb2dnZXIuaW5mbyhgSGF0cyBTZXJ2aWNlIHN0YXJ0ZWQgb24gcG9ydCAke1BPUlR9YCk7XG59KVxuXG5hc3luYyBmdW5jdGlvbiBudW1IYXRzKHJlcSwgcmVzLCBuZXh0KSB7XG5cbiAgICBuZXh0KCk7XG59XG5cbnJvdXRlci5nZXQoJy9saXN0JywgYXN5bmMgZnVuY3Rpb24gbGlzdChyZXEsIHJlcykge1xuICAgIGxvZ2dlci5pbmZvKFwiR2V0dGluZyBoYXRzXCIpXG4gICAgbGV0IGRhdGEgPSBhd2FpdCBnZXRIYXREYXRhKClcbiAgICBsb2dnZXIuaW5mbyhgZmV0Y2hlZCAke2RhdGEubGVuZ3RofSBoYXRzYCk7XG4gbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdoYXRMaXN0U2l6ZScsIGRhdGEubGVuZ3RoKTtcbiAgICByZXMuc2VuZChkYXRhKVxufSk7XG5cbmFzeW5jIGZ1bmN0aW9uIGFwcGx5SGF0cyhyZXEsIHJlcywgbmV4dCkge1xuICAgIGxldCBudW1IYXRzID0gMTtcbiAgICBpZiAocmVxLnF1ZXJ5Lm51bWJlciAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgbnVtSGF0cyA9IHJlcS5xdWVyeS5udW1iZXIgXG4gICAgfVxuICAgIFxuICAgIGxldCBoYXQgPSBudWxsO1xuICAgIGlmIChyZXEucXVlcnkuc3R5bGUgPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG5ld3JlbGljLmFkZEN1c3RvbUF0dHJpYnV0ZSgncmFuZG9tJywgdHJ1ZSk7XG4gICAgICAgIGhhdCA9IGF3YWl0IGdldFJhbmRvbUhhdCgpXG4gICAgfSBlbHNlIHtcbiAgICAgICAgbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdyYW5kb20nLCBmYWxzZSk7XG4gICAgICAgIGhhdCA9IGF3YWl0IGdldFNwZWNpZmljSGF0KHJlcS5xdWVyeS5zdHlsZSk7XG4gICAgfSAgICBcbiAgICBpZiAoaGF0ID09IG51bGwpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oYEhhdCBzdHlsZSAke3JlcS5xdWVyeS5zdHlsZX0gZG9lcyBub3QgZXhpc3RgKVxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQoe1xuICAgICAgICAgICAgbWVzc2FnZTogJ1RoaXMgaGF0IHN0eWxlIGRvZXMgbm90IGV4aXN0ISBJZiB5b3Ugd2FudCB0aGlzIHN0eWxlIC0gdHJ5IHN1Ym1pdHRpbmcgaXQnXG4gICAgICAgICB9KTsgICAgICAgICAgICAgXG4gICAgfVxuICAgIGxvZ2dlci5pbmZvKGBHb2luZyB0byBhcHBseSAke251bUhhdHN9ICR7cmVxLnF1ZXJ5LnN0eWxlfSBoYXQocykgdG8gaW1hZ2VgKTtcblxuICAgIGxldCBiNjRSZXN1bHQgPSBhd2FpdCByZXF1ZXN0TWFuaXB1bGF0ZShyZXEuZmFjZSwgaGF0LCBudW1IYXRzKVxuICAgIHJlcy5zZW5kKGI2NFJlc3VsdClcbn1cblxucm91dGVyLmdldCgnL2hhdG1lJywgYXN5bmMgZnVuY3Rpb24gaGF0bWVHZXQocmVxLCByZXMsIG5leHQpIHtcbiAgICBsZXQgcXMgPSB1cmwucGFyc2UocmVxLnVybCkucXVlcnk7XG4gICAgbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdxcycsIHFzKTtcbiAgICBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ2N1c3RvbUZhY2UnLCBmYWxzZSk7XG4gICAgcmVxLmZhY2UgPSBhd2FpdCBkZWZhdWx0Qm9zcygpXG4gICAgYXdhaXQgYXBwbHlIYXRzKHJlcSwgcmVzLCBuZXh0KTtcbn0pO1xuXG5yb3V0ZXIucG9zdCgnL2hhdG1lJywgdXBsb2FkLmFueSgpLCBhc3luYyBmdW5jdGlvbiBoYXRtZVBvc3QocmVxLCByZXMsIG5leHQpIHtcbiAgICBsZXQgcXMgPSB1cmwucGFyc2UocmVxLnVybCkucXVlcnk7XG4gICAgbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdxcycsIHFzKTtcbiAgICBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ2N1c3RvbUZhY2UnLCB0cnVlKTtcbiAgICByZXEuZmFjZSA9IHJlcS5maWxlc1swXS5idWZmZXJcbiAgICBhd2FpdCBhcHBseUhhdHMocmVxLCByZXMsIG5leHQpO1xufSk7ICJdfQ==