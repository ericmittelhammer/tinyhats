"use strict";

var _newrelic = require("newrelic");

var _express = require("express");

var _expressAsyncErrors = require("express-async-errors");

var _multer = require("multer");

var _url = require("url");

var _winston = require("winston");

var _winstonEnricher = require("@newrelic/winston-enricher");

var _helpers = require("./src/helpers.js");

const logger = _winston.createLogger({
  level: 'info',
  transports: [new _winston.transports.Console()],
  format: _winston.format.combine(_winston.format((info, opts) => Object.assign(info, {
    module: __filename
  }))(), _winston.format.errors({
    stack: true
  }), _winstonEnricher(), _winston.format.json())
});

const upload = _multer();

const app = _express();

var router = _express.Router();

const PORT = 1337; // for testing locally: node -r dotenv/config index.js  
// https://stackoverflow.com/questions/28305120/differences-between-express-router-and-app-get

app.use(function (req, res, next) {
  logger.info(`requested: ${req.url}`);
  next();
});
app.use('/', router);
app.listen(PORT, () => {
  logger.info(`Hats Service started on port ${PORT}`);
});

async function numHats(req, res, next) {
  next();
}

router.get('/list', async function list(req, res) {
  logger.info("Getting hats");
  let data = await (0, _helpers.getHatData)();
  logger.info(`fetched ${data.length} hats`);

  _newrelic.addCustomAttribute('hatListSize', data.length);

  res.send(data);
});

async function applyHats(req, res, next) {
  let numHats = 1;

  if (req.query.number != undefined) {
    numHats = req.query.number;
  }

  let sanitizedHatStyle = (0, _helpers.sanitizeInput)(req.query.style);
  let hat = null;

  if (req.query.style == undefined) {
    _newrelic.addCustomAttribute('random', true);

    hat = await (0, _helpers.getRandomHat)();
  } else {
    _newrelic.addCustomAttribute('random', false);

    hat = await (0, _helpers.getSpecificHat)(sanitizedHatStyle);
  }

  if (hat == null) {
    logger.info(`Invalid hat style`);
    throw new Error(`Invalid hat style`);
  }

  logger.info(`Going to apply ${numHats} ${req.query.style} hats to image`);
  let b64Result = await (0, _helpers.requestManipulate)(req.face, hat, numHats);
  res.send(b64Result);
}

router.get('/hatme', async function hatmeGet(req, res, next) {
  let qs = _url.parse(req.url).query;

  _newrelic.addCustomAttribute('requestedStyle', req.query.style);

  _newrelic.addCustomAttribute('customFace', false);

  req.face = await (0, _helpers.defaultBoss)();
  await applyHats(req, res, next);
});
router.post('/hatme', upload.any(), async function hatmePost(req, res, next) {
  let qs = _url.parse(req.url).query;

  _newrelic.addCustomAttribute('requestedStyle', req.query.style);

  _newrelic.addCustomAttribute('customFace', true);

  req.face = req.files[0].buffer;
  await applyHats(req, res, next);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2hhdC1pbmRleC5qcyJdLCJuYW1lcyI6WyJsb2dnZXIiLCJ3aW5zdG9uIiwiY3JlYXRlTG9nZ2VyIiwibGV2ZWwiLCJ0cmFuc3BvcnRzIiwiQ29uc29sZSIsImZvcm1hdCIsImNvbWJpbmUiLCJpbmZvIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsIm1vZHVsZSIsIl9fZmlsZW5hbWUiLCJlcnJvcnMiLCJzdGFjayIsIm5ld3JlbGljRm9ybWF0dGVyIiwianNvbiIsInVwbG9hZCIsIm11bHRlciIsImFwcCIsImV4cHJlc3MiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJQT1JUIiwidXNlIiwicmVxIiwicmVzIiwibmV4dCIsInVybCIsImxpc3RlbiIsIm51bUhhdHMiLCJnZXQiLCJsaXN0IiwiZGF0YSIsImxlbmd0aCIsIm5ld3JlbGljIiwiYWRkQ3VzdG9tQXR0cmlidXRlIiwic2VuZCIsImFwcGx5SGF0cyIsInF1ZXJ5IiwibnVtYmVyIiwidW5kZWZpbmVkIiwic2FuaXRpemVkSGF0U3R5bGUiLCJzdHlsZSIsImhhdCIsIkVycm9yIiwiYjY0UmVzdWx0IiwiZmFjZSIsImhhdG1lR2V0IiwicXMiLCJwYXJzZSIsInBvc3QiLCJhbnkiLCJoYXRtZVBvc3QiLCJmaWxlcyIsImJ1ZmZlciJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFnQkE7O0FBZEEsTUFBTUEsTUFBTSxHQUFHQyxRQUFPLENBQUNDLFlBQVIsQ0FBcUI7QUFDaENDLEVBQUFBLEtBQUssRUFBRSxNQUR5QjtBQUVoQ0MsRUFBQUEsVUFBVSxFQUFFLENBQ1YsSUFBSUgsUUFBTyxDQUFDRyxVQUFSLENBQW1CQyxPQUF2QixFQURVLENBRm9CO0FBS2hDQyxFQUFBQSxNQUFNLEVBQUVMLFFBQU8sQ0FBQ0ssTUFBUixDQUFlQyxPQUFmLENBQ0pOLFFBQU8sQ0FBQ0ssTUFBUixDQUFlLENBQUNFLElBQUQsRUFBT0MsSUFBUCxLQUFnQkMsTUFB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S0FBeEQ7O0FBQ0FSLEVBQUFBLFNBQVEsQ0FBQ0Msa0JBQVQsQ0FBNEIsWUFBNUIsRUFBMEMsSUFBMUM7O0FBQ0FYLEVBQUFBLEdBQUcsQ0FBQ3NCLElBQUosR0FBV3RCLEdBQUcsQ0FBQzZCLEtBQUosQ0FBVSxDQUFWLEVBQWFDLE1BQXhCO0FBQ0EsUUFBTWpCLFNBQVMsQ0FBQ2IsR0FBRCxFQUFNQyxHQUFOLEVBQVdDLElBQVgsQ0FBZjtBQUNILENBTkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbmV3cmVsaWMgZnJvbSAnbmV3cmVsaWMnXG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJ1xuaW1wb3J0IGV4cHJlc3NBc3luY0Vycm9ycyBmcm9tICdleHByZXNzLWFzeW5jLWVycm9ycydcbmltcG9ydCBtdWx0ZXIgZnJvbSAnbXVsdGVyJ1xuaW1wb3J0IHVybCBmcm9tICd1cmwnXG5pbXBvcnQgd2luc3RvbiBmcm9tICd3aW5zdG9uJ1xuaW1wb3J0IG5ld3JlbGljRm9ybWF0dGVyIGZyb20gJ0BuZXdyZWxpYy93aW5zdG9uLWVucmljaGVyJ1xuXG5jb25zdCBsb2dnZXIgPSB3aW5zdG9uLmNyZWF0ZUxvZ2dlcih7XG4gICAgbGV2ZWw6ICdpbmZvJyxcbiAgICB0cmFuc3BvcnRzOiBbXG4gICAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoKVxuICAgIF0sXG4gICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgICAgICB3aW5zdG9uLmZvcm1hdCgoaW5mbywgb3B0cykgPT4gT2JqZWN0LmFzc2lnbihpbmZvLCB7bW9kdWxlOiBfX2ZpbGVuYW1lfSkpKCksXG4gICAgICAgIHdpbnN0b24uZm9ybWF0LmVycm9ycyh7c3RhY2s6IHRydWV9KSxcbiAgICAgICAgbmV3cmVsaWNGb3JtYXR0ZXIoKSxcbiAgICAgICAgd2luc3Rvbi5mb3JtYXQuanNvbigpXG4gICAgKVxuICB9KTtcblxuXG5pbXBvcnQgeyBkZWZhdWx0Qm9zcywgZ2V0UmFuZG9tSGF0LCBnZXRTcGVjaWZpY0hhdCwgcmVxdWVzdE1hbmlwdWxhdGUsIGdldEhhdERhdGEsIHNhbml0aXplSW5wdXQgfSBmcm9tICcuL3NyYy9oZWxwZXJzLmpzJ1xuY29uc3QgdXBsb2FkID0gbXVsdGVyKClcbmNvbnN0IGFwcCA9IGV4cHJlc3MoKVxudmFyIHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5jb25zdCBQT1JUID0gMTMzN1xuXG4vLyBmb3IgdGVzdGluZyBsb2NhbGx5OiBub2RlIC1yIGRvdGVudi9jb25maWcgaW5kZXguanMgIFxuLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMjgzMDUxMjAvZGlmZmVyZW5jZXMtYmV0d2Vlbi1leHByZXNzLXJvdXRlci1hbmQtYXBwLWdldFxuXG5hcHAudXNlKGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgbG9nZ2VyLmluZm8oYHJlcXVlc3RlZDogJHtyZXEudXJsfWApO1xuICAgIG5leHQoKTtcbn0pXG5cbmFwcC51c2UoJy8nLCByb3V0ZXIpXG5cbmFwcC5saXN0ZW4oUE9SVCwgKCkgPT4ge1xuICAgIGxvZ2dlci5pbmZvKGBIYXRzIFNlcnZpY2Ugc3RhcnRlZCBvbiBwb3J0ICR7UE9SVH1gKTtcbn0pXG5cbmFzeW5jIGZ1bmN0aW9uIG51bUhhdHMocmVxLCByZXMsIG5leHQpIHtcblxuICAgIG5leHQoKTtcbn1cblxucm91dGVyLmdldCgnL2xpc3QnLCBhc3luYyBmdW5jdGlvbiBsaXN0KHJlcSwgcmVzKSB7XG4gICAgbG9nZ2VyLmluZm8oXCJHZXR0aW5nIGhhdHNcIilcbiAgICBsZXQgZGF0YSA9IGF3YWl0IGdldEhhdERhdGEoKVxuICAgIGxvZ2dlci5pbmZvKGBmZXRjaGVkICR7ZGF0YS5sZW5ndGh9IGhhdHNgKTtcbiBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ2hhdExpc3RTaXplJywgZGF0YS5sZW5ndGgpO1xuICAgIHJlcy5zZW5kKGRhdGEpXG59KTtcblxuYXN5bmMgZnVuY3Rpb24gYXBwbHlIYXRzKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgbGV0IG51bUhhdHMgPSAxO1xuICAgIGlmIChyZXEucXVlcnkubnVtYmVyICE9IHVuZGVmaW5lZCkge1xuICAgICAgICBudW1IYXRzID0gcmVxLnF1ZXJ5Lm51bWJlciBcbiAgICB9XG4gICAgXG4gICAgbGV0IHNhbml0aXplZEhhdFN0eWxlID0gc2FuaXRpemVJbnB1dChyZXEucXVlcnkuc3R5bGUpO1xuXG4gICAgbGV0IGhhdCA9IG51bGw7XG4gICAgaWYgKHJlcS5xdWVyeS5zdHlsZSA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdyYW5kb20nLCB0cnVlKTtcbiAgICAgICAgaGF0ID0gYXdhaXQgZ2V0UmFuZG9tSGF0KClcbiAgICB9IGVsc2Uge1xuICAgICAgICBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ3JhbmRvbScsIGZhbHNlKTtcbiAgICAgICAgaGF0ID0gYXdhaXQgZ2V0U3BlY2lmaWNIYXQoc2FuaXRpemVkSGF0U3R5bGUpO1xuICAgIH0gICAgXG4gICAgaWYgKGhhdCA9PSBudWxsKSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKGBJbnZhbGlkIGhhdCBzdHlsZWApXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBoYXQgc3R5bGVgKTtcblxuICAgIH1cbiAgICBsb2dnZXIuaW5mbyhgR29pbmcgdG8gYXBwbHkgJHtudW1IYXRzfSAke3JlcS5xdWVyeS5zdHlsZX0gaGF0cyB0byBpbWFnZWApO1xuXG4gICAgbGV0IGI2NFJlc3VsdCA9IGF3YWl0IHJlcXVlc3RNYW5pcHVsYXRlKHJlcS5mYWNlLCBoYXQsIG51bUhhdHMpXG4gICAgcmVzLnNlbmQoYjY0UmVzdWx0KVxufVxuXG5yb3V0ZXIuZ2V0KCcvaGF0bWUnLCBhc3luYyBmdW5jdGlvbiBoYXRtZUdldChyZXEsIHJlcywgbmV4dCkge1xuICAgIGxldCBxcyA9IHVybC5wYXJzZShyZXEudXJsKS5xdWVyeTtcbiAgICBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ3JlcXVlc3RlZFN0eWxlJywgcmVxLnF1ZXJ5LnN0eWxlKTtcbiAgICBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ2N1c3RvbUZhY2UnLCBmYWxzZSk7XG4gICAgcmVxLmZhY2UgPSBhd2FpdCBkZWZhdWx0Qm9zcygpXG4gICAgYXdhaXQgYXBwbHlIYXRzKHJlcSwgcmVzLCBuZXh0KTtcbn0pO1xuXG5yb3V0ZXIucG9zdCgnL2hhdG1lJywgdXBsb2FkLmFueSgpLCBhc3luYyBmdW5jdGlvbiBoYXRtZVBvc3QocmVxLCByZXMsIG5leHQpIHtcbiAgICBsZXQgcXMgPSB1cmwucGFyc2UocmVxLnVybCkucXVlcnk7XG4gICAgbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdyZXF1ZXN0ZWRTdHlsZScsIHJlcS5xdWVyeS5zdHlsZSk7XG4gICAgbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdjdXN0b21GYWNlJywgdHJ1ZSk7XG4gICAgcmVxLmZhY2UgPSByZXEuZmlsZXNbMF0uYnVmZmVyXG4gICAgYXdhaXQgYXBwbHlIYXRzKHJlcSwgcmVzLCBuZXh0KTtcbn0pOyAiXX0=