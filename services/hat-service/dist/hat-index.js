"use strict";

var _newrelic = require("newrelic");

var _express = require("express");

var _expressAsyncErrors = require("express-async-errors");

var _multer = require("multer");

var _url = require("url");

var _winston = require("winston");

var _winstonEnricher = require("@newrelic/winston-enricher");

var _helpers = require("./src/helpers.js");

const logger = _winston.createLogger({
  level: 'info',
  transports: [new _winston.transports.Console()],
  format: _winston.format.combine(_winston.format((info, opts) => Object.assign(info, {
    module: __filename
  }))(), _winston.format.errors({
    stack: true
  }), _winstonEnricher(), _winston.format.json())
});

const upload = _multer();

const app = _express();

var router = _express.Router();

const PORT = 1337; // for testing locally: node -r dotenv/config index.js  
// https://stackoverflow.com/questions/28305120/differences-between-express-router-and-app-get

app.use(function (req, res, next) {
  logger.info(`requested: ${req.url}`);
  next();
});
app.use('/', router);
app.listen(PORT, () => {
  logger.info(`Hats Service started on port ${PORT}`);
});

async function numHats(req, res, next) {
  next();
}

router.get('/list', async function list(req, res) {
  logger.info("Getting hats");
  let data = await (0, _helpers.getHatData)();
  logger.info(`fetched ${data.length} hats`);

  _newrelic.addCustomAttribute('hatListSize', data.length);

  res.send(data);
});

async function applyHats(req, res, next) {
  let numHats = 1;

  if (req.query.number != undefined) {
    numHats = req.query.number;
  }

  let sanitizedHatStyle = req.query.style; //.toLowerCase();

  let hat = null;

  if (req.query.style == undefined) {
    _newrelic.addCustomAttribute('random', true);

    hat = await (0, _helpers.getRandomHat)();
  } else {
    _newrelic.addCustomAttribute('random', false);

    hat = await (0, _helpers.getSpecificHat)(sanitizedHatStyle);
  }

  if (hat == null) {
    logger.info(`Invalid hat style`);
    throw new Error(`Invalid hat style`);
  }

  logger.info(`Going to apply ${numHats} ${req.query.style} hats to image`);
  let b64Result = await (0, _helpers.requestManipulate)(req.face, hat, numHats);
  res.send(b64Result);
}

router.get('/hatme', async function hatmeGet(req, res, next) {
  let qs = _url.parse(req.url).query;

  _newrelic.addCustomAttribute('requestedStyle', req.query.style);

  _newrelic.addCustomAttribute('customFace', false);

  req.face = await (0, _helpers.defaultBoss)();
  await applyHats(req, res, next);
});
router.post('/hatme', upload.any(), async function hatmePost(req, res, next) {
  let qs = _url.parse(req.url).query;

  _newrelic.addCustomAttribute('requestedStyle', req.query.style);

  _newrelic.addCustomAttribute('customFace', true);

  req.face = req.files[0].buffer;
  await applyHats(req, res, next);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2hhdC1pbmRleC5qcyJdLCJuYW1lcyI6WyJsb2dnZXIiLCJ3aW5zdG9uIiwiY3JlYXRlTG9nZ2VyIiwibGV2ZWwiLCJ0cmFuc3BvcnRzIiwiQ29uc29sZSIsImZvcm1hdCIsImNvbWJpbmUiLCJpbmZvIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsIm1vZHVsZSIsIl9fZmlsZW5hbWUiLCJlcnJvcnMiLCJzdGFjayIsIm5ld3JlbGljRm9ybWF0dGVyIiwianNvbiIsInVwbG9hZCIsIm11bHRlciIsImFwcCIsImV4cHJlc3MiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJQT1JUIiwidXNlIiwicmVxIiwicmVzIiwibmV4dCIsInVybCIsImxpc3RlbiIsIm51bUhhdHMiLCJnZXQiLCJsaXN0IiwiZGF0YSIsImxlbmd0aCIsIm5ld3JlbGljIiwiYWRkQ3VzdG9tQXR0cmlidXRlIiwic2VuZCIsImFwcGx5SGF0cyIsInF1ZXJ5IiwibnVtYmVyIiwidW5kZWZpbmVkIiwic2FuaXRpemVkSGF0U3R5bGUiLCJzdHlsZSIsImhhdCIsIkVycm9yIiwiYjY0UmVzdWx0IiwiZmFjZSIsImhhdG1lR2V0IiwicXMiLCJwYXJzZSIsInBvc3QiLCJhbnkiLCJoYXRtZVBvc3QiLCJmaWxlcyIsImJ1ZmZlciJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFnQkE7O0FBZEEsTUFBTUEsTUFBTSxHQUFHQyxRQUFPLENBQUNDLFlBQVIsQ0FBcUI7QUFDaENDLEVBQUFBLEtBQUssRUFBRSxNQUR5QjtBQUVoQ0MsRUFBQUEsVUFBVSxFQUFFLENBQ1YsSUFBSUgsUUFBTyxDQUFDRyxVQUFSLENBQW1CQyxPQUF2QixFQURVLENBRm9CO0FBS2hDQyxFQUFBQSxNQUFNLEVBQUVMLFFBQU8sQ0FBQ0ssTUFBUixDQUFlQyxPQUFmLENBQ0pOLFFBQU8sQ0FBQ0ssTUFBUixDQUFlLENBQUNFLElBQUQsRUFBT0MsSUFBUCxLQUFnQkMsTUFB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LEtBQXhEOztBQUNBUixFQUFBQSxTQUFRLENBQUNDLGtCQUFULENBQTRCLFlBQTVCLEVBQTBDLElBQTFDOztBQUNBWCxFQUFBQSxHQUFHLENBQUNzQixJQUFKLEdBQVd0QixHQUFHLENBQUM2QixLQUFKLENBQVUsQ0FBVixFQUFhQyxNQUF4QjtBQUNBLFFBQU1qQixTQUFTLENBQUNiLEdBQUQsRUFBTUMsR0FBTixFQUFXQyxJQUFYLENBQWY7QUFDSCxDQU5EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG5ld3JlbGljIGZyb20gJ25ld3JlbGljJ1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcydcbmltcG9ydCBleHByZXNzQXN5bmNFcnJvcnMgZnJvbSAnZXhwcmVzcy1hc3luYy1lcnJvcnMnXG5pbXBvcnQgbXVsdGVyIGZyb20gJ211bHRlcidcbmltcG9ydCB1cmwgZnJvbSAndXJsJ1xuaW1wb3J0IHdpbnN0b24gZnJvbSAnd2luc3RvbidcbmltcG9ydCBuZXdyZWxpY0Zvcm1hdHRlciBmcm9tICdAbmV3cmVsaWMvd2luc3Rvbi1lbnJpY2hlcidcblxuY29uc3QgbG9nZ2VyID0gd2luc3Rvbi5jcmVhdGVMb2dnZXIoe1xuICAgIGxldmVsOiAnaW5mbycsXG4gICAgdHJhbnNwb3J0czogW1xuICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKClcbiAgICBdLFxuICAgIGZvcm1hdDogd2luc3Rvbi5mb3JtYXQuY29tYmluZShcbiAgICAgICAgd2luc3Rvbi5mb3JtYXQoKGluZm8sIG9wdHMpID0+IE9iamVjdC5hc3NpZ24oaW5mbywge21vZHVsZTogX19maWxlbmFtZX0pKSgpLFxuICAgICAgICB3aW5zdG9uLmZvcm1hdC5lcnJvcnMoe3N0YWNrOiB0cnVlfSksXG4gICAgICAgIG5ld3JlbGljRm9ybWF0dGVyKCksXG4gICAgICAgIHdpbnN0b24uZm9ybWF0Lmpzb24oKVxuICAgIClcbiAgfSk7XG5cblxuaW1wb3J0IHsgZGVmYXVsdEJvc3MsIGdldFJhbmRvbUhhdCwgZ2V0U3BlY2lmaWNIYXQsIHJlcXVlc3RNYW5pcHVsYXRlLCBnZXRIYXREYXRhIH0gZnJvbSAnLi9zcmMvaGVscGVycy5qcydcbmNvbnN0IHVwbG9hZCA9IG11bHRlcigpXG5jb25zdCBhcHAgPSBleHByZXNzKClcbnZhciByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuY29uc3QgUE9SVCA9IDEzMzdcblxuLy8gZm9yIHRlc3RpbmcgbG9jYWxseTogbm9kZSAtciBkb3RlbnYvY29uZmlnIGluZGV4LmpzICBcbi8vIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzI4MzA1MTIwL2RpZmZlcmVuY2VzLWJldHdlZW4tZXhwcmVzcy1yb3V0ZXItYW5kLWFwcC1nZXRcblxuYXBwLnVzZShmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIGxvZ2dlci5pbmZvKGByZXF1ZXN0ZWQ6ICR7cmVxLnVybH1gKTtcbiAgICBuZXh0KCk7XG59KVxuXG5hcHAudXNlKCcvJywgcm91dGVyKVxuXG5hcHAubGlzdGVuKFBPUlQsICgpID0+IHtcbiAgICBsb2dnZXIuaW5mbyhgSGF0cyBTZXJ2aWNlIHN0YXJ0ZWQgb24gcG9ydCAke1BPUlR9YCk7XG59KVxuXG5hc3luYyBmdW5jdGlvbiBudW1IYXRzKHJlcSwgcmVzLCBuZXh0KSB7XG5cbiAgICBuZXh0KCk7XG59XG5cbnJvdXRlci5nZXQoJy9saXN0JywgYXN5bmMgZnVuY3Rpb24gbGlzdChyZXEsIHJlcykge1xuICAgIGxvZ2dlci5pbmZvKFwiR2V0dGluZyBoYXRzXCIpXG4gICAgbGV0IGRhdGEgPSBhd2FpdCBnZXRIYXREYXRhKClcbiAgICBsb2dnZXIuaW5mbyhgZmV0Y2hlZCAke2RhdGEubGVuZ3RofSBoYXRzYCk7XG4gbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdoYXRMaXN0U2l6ZScsIGRhdGEubGVuZ3RoKTtcbiAgICByZXMuc2VuZChkYXRhKVxufSk7XG5cbmFzeW5jIGZ1bmN0aW9uIGFwcGx5SGF0cyhyZXEsIHJlcywgbmV4dCkge1xuICAgIGxldCBudW1IYXRzID0gMTtcbiAgICBpZiAocmVxLnF1ZXJ5Lm51bWJlciAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgbnVtSGF0cyA9IHJlcS5xdWVyeS5udW1iZXIgXG4gICAgfVxuICAgIFxuICAgIGxldCBzYW5pdGl6ZWRIYXRTdHlsZSA9IHJlcS5xdWVyeS5zdHlsZS8vLnRvTG93ZXJDYXNlKCk7XG5cbiAgICBsZXQgaGF0ID0gbnVsbDtcbiAgICBpZiAocmVxLnF1ZXJ5LnN0eWxlID09IHVuZGVmaW5lZCkge1xuICAgICAgICBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ3JhbmRvbScsIHRydWUpO1xuICAgICAgICBoYXQgPSBhd2FpdCBnZXRSYW5kb21IYXQoKVxuICAgIH0gZWxzZSB7XG4gICAgICAgIG5ld3JlbGljLmFkZEN1c3RvbUF0dHJpYnV0ZSgncmFuZG9tJywgZmFsc2UpO1xuICAgICAgICBoYXQgPSBhd2FpdCBnZXRTcGVjaWZpY0hhdChzYW5pdGl6ZWRIYXRTdHlsZSk7XG4gICAgfSAgICBcbiAgICBpZiAoaGF0ID09IG51bGwpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oYEludmFsaWQgaGF0IHN0eWxlYClcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGhhdCBzdHlsZWApO1xuXG4gICAgfVxuICAgIGxvZ2dlci5pbmZvKGBHb2luZyB0byBhcHBseSAke251bUhhdHN9ICR7cmVxLnF1ZXJ5LnN0eWxlfSBoYXRzIHRvIGltYWdlYCk7XG5cbiAgICBsZXQgYjY0UmVzdWx0ID0gYXdhaXQgcmVxdWVzdE1hbmlwdWxhdGUocmVxLmZhY2UsIGhhdCwgbnVtSGF0cylcbiAgICByZXMuc2VuZChiNjRSZXN1bHQpXG59XG5cbnJvdXRlci5nZXQoJy9oYXRtZScsIGFzeW5jIGZ1bmN0aW9uIGhhdG1lR2V0KHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgbGV0IHFzID0gdXJsLnBhcnNlKHJlcS51cmwpLnF1ZXJ5O1xuICAgIG5ld3JlbGljLmFkZEN1c3RvbUF0dHJpYnV0ZSgncmVxdWVzdGVkU3R5bGUnLCByZXEucXVlcnkuc3R5bGUpO1xuICAgIG5ld3JlbGljLmFkZEN1c3RvbUF0dHJpYnV0ZSgnY3VzdG9tRmFjZScsIGZhbHNlKTtcbiAgICByZXEuZmFjZSA9IGF3YWl0IGRlZmF1bHRCb3NzKClcbiAgICBhd2FpdCBhcHBseUhhdHMocmVxLCByZXMsIG5leHQpO1xufSk7XG5cbnJvdXRlci5wb3N0KCcvaGF0bWUnLCB1cGxvYWQuYW55KCksIGFzeW5jIGZ1bmN0aW9uIGhhdG1lUG9zdChyZXEsIHJlcywgbmV4dCkge1xuICAgIGxldCBxcyA9IHVybC5wYXJzZShyZXEudXJsKS5xdWVyeTtcbiAgICBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ3JlcXVlc3RlZFN0eWxlJywgcmVxLnF1ZXJ5LnN0eWxlKTtcbiAgICBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ2N1c3RvbUZhY2UnLCB0cnVlKTtcbiAgICByZXEuZmFjZSA9IHJlcS5maWxlc1swXS5idWZmZXJcbiAgICBhd2FpdCBhcHBseUhhdHMocmVxLCByZXMsIG5leHQpO1xufSk7ICJdfQ==