"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.defaultBoss = defaultBoss;
exports.downloadBuffer = downloadBuffer;
exports.getHatData = getHatData;
exports.getRandomHat = getRandomHat;
exports.getSpecificHat = getSpecificHat;
exports.listPictures = listPictures;
exports.requestManipulate = requestManipulate;

var _newrelic = require("newrelic");

var _http = require("http2");

var _mysql = require("mysql2");

var _nodeFetch = require("node-fetch");

var _formData = require("form-data");

var _winston = require("winston");

var _winstonEnricher = require("@newrelic/winston-enricher");

const logger = _winston.createLogger({
  level: 'info',
  transports: [new _winston.transports.Console()],
  format: _winston.format.combine(_winston.format((info, opts) => Object.assign(info, {
    module: __filename
  }))(), _winston.format.errors({
    stack: true
  }), _winstonEnricher(), _winston.format.json())
});

const HOST = process.env.HOST;
const PASSWORD = process.env.PASSWORD;

const pool = _mysql.createPool({
  host: HOST,
  port: '3306',
  user: "admin",
  password: PASSWORD,
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 3
});

async function listPictures() {
  var sql = "SELECT * FROM main.images WHERE approve='true'";
  const results = await pool.promise().query(sql);
  return results;
}

;

async function downloadBuffer(url) {
  let resp = await _nodeFetch(url, {
    method: 'GET'
  }); // receive the response

  let data = await resp.arrayBuffer();
  return data;
}

async function getSpecificHat(style) {
  var sql = `SELECT * FROM main.images WHERE BINARY description='${style}' AND approve='true'`;
  const results = await pool.promise().query(sql).catch(err => logger.error(err)); //logger.info(`getSpecificHat results: ${JSON.stringify(results)}`);

  let hatList = results[0]; //logger.info(`hatList: ${JSON.stringify(hatList)}`)

  if (hatList.length == 0) {
    return null;
  }

  let randNum = Math.floor(Math.random() * hatList.length);
  let hat = hatList[randNum];
  let hatLink = hat.url;

  _newrelic.addCustomAttribute('style', hat.description);

  logger.info(`hatLink: ${hatLink}`);
  let image = await downloadBuffer(hatLink);
  image = Buffer.from(image);
  return image;
}

async function getHatData() {
  var sql = `SELECT description, url FROM main.images WHERE approve='true'`;
  const results = await pool.promise().query(sql); //logger.info(`gethatdata results: ${results}`);

  let hatList = results[0]; //logger.info(hatList)

  return hatList;
}

async function getRandomHat() {
  // get random hat picture
  let hats = await listPictures();
  let hatList = hats[0]; //logger.info(`getRandomHat hatlistL ${hatList}`);

  let randNum = Math.floor(Math.random() * hatList.length);
  let hat = hatList[randNum];
  let hatLink = hat.url;

  _newrelic.addCustomAttribute('style', hat.description);

  logger.info(`getRandomHat hatLink ${hatLink}`);
  let image = await downloadBuffer(hatLink);
  image = Buffer.from(image);
  return image;
}

async function defaultBoss() {
  //my fav boss ever
  let johnKinmonth = await downloadBuffer("https://user-images.githubusercontent.com/69332964/128645143-86405a62-691b-4de9-8500-b9362675e1db.png");
  johnKinmonth = Buffer.from(johnKinmonth);
  return johnKinmonth;
}

async function requestManipulate(face, hat, numberHats) {
  // hit the upload endpoint to upload image and retrieve unique image id
  let faceData = face;

  for (var i = numberHats; i >= 1; i--) {
    logger.info(`Applying hat ${i} of ${numberHats}`);
    let translate = i * 0.6;
    let rotate = i * 10;
    let formData = await createForm(faceData, hat);
    const formHeaders = formData.getHeaders();
    const manUrl = `http://${process.env.MANIPULATE_ENDPOINT}/manipulate?translate=${translate}&rotate=${rotate}`;
    logger.info(`POST ${manUrl}`);
    const manipulateRequest = await _nodeFetch(manUrl, {
      method: 'POST',
      body: formData,
      headers: { ...formHeaders
      }
    });
    var b64Result = await manipulateRequest.json();

    if (i == 1) {
      faceData = b64Result;
    } else {
      faceData = Buffer.from(b64Result.finalBaby.replace("data:image/png;base64,", ""), "base64");
    }

    logger.info(`Received response from /manipulate [hat ${i}]`);
  }

  return faceData;
}

async function createForm(face, hat) {
  let formData = new _formData();
  formData.append('file', face, {
    filename: "face",
    data: face
  });
  formData.append('file', hat, {
    filename: "hat",
    data: hat
  });
  return formData;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsIndpbnN0b24iLCJjcmVhdGVMb2dnZXIiLCJsZXZlbCIsInRyYW5zcG9ydHMiLCJDb25zb2xlIiwiZm9ybWF0IiwiY29tYmluZSIsImluZm8iLCJvcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwibW9kdWxlIiwiX19maWxlbmFtZSIsImVycm9ycyIsInN0YWNrIiwibmV3cmVsaWNGb3JtYXR0ZXIiLCJqc29uIiwiSE9TVCIsInByb2Nlc3MiLCJlbnYiLCJQQVNTV09SRCIsInBvb2wiLCJteXNxbCIsImNyZWF0ZVBvb2wiLCJob3N0IiwicG9ydCIsInVzZXIiLCJwYXNzd29yZCIsIndhaXRGb3JDb25uZWN0aW9ucyIsImNvbm5lY3Rpb25MaW1pdCIsInF1ZXVlTGltaXQiLCJsaXN0UGljdHVyZXMiLCJzcWwiLCJyZXN1bHRzIiwicHJvbWlzZSIsInF1ZXJ5IiwiZG93bmxvYWRCdWZmZXIiLCJ1cmwiLCJyZXNwIiwiZmV0Y2giLCJtZXRob2QiLCJkYXRhIiwiYXJyYXlCdWZmZXIiLCJnZXRTcGVjaWZpY0hhdCIsInN0eWxlIiwiY2F0Y2giLCJlcnIiLCJlcnJvciIsImhhdExpc3QiLCJsZW5ndGgiLCJyYW5kTnVtIiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwiaGF0IiwiaGF0TGluayIsIm5ld3JlbGljIiwiYWRkQ3VzdG9tQXR0cmlidXRlIiwiZGVzY3JpcHRpb24iLCJpbWFnZSIsIkJ1ZmZlciIsImZyb20iLCJnZXRIYXREYXRhIiwiZ2V0UmFuZG9tSGF0IiwiaGF0cyIsImRlZmF1bHRCb3NzIiwiam9obktpbm1vbnRoIiwicmVxdWVzdE1hbmlwdWxhdGUiLCJmYWNlIiwibnVtYmVySGF0cyIsImZhY2VEYXRhIiwiaSIsInRyYW5zbGF0ZSIsInJvdGF0ZSIsImZvcm1EYXRhIiwiY3JlYXRlRm9ybSIsImZvcm1IZWFkZXJzIiwiZ2V0SGVhZGVycyIsIm1hblVybCIsIk1BTklQVUxBVEVfRU5EUE9JTlQiLCJtYW5pcHVsYXRlUmVxdWVzdCIsImJvZHkiLCJoZWFkZXJzIiwiYjY0UmVzdWx0IiwiZmluYWxCYWJ5IiwicmVwbGFjZSIsIkZvcm1EYXRhIiwiYXBwZW5kIiwiZmlsZW5hbWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxNQUFNLEdBQUdDLFFBQU8sQ0FBQ0MsWUFBUixDQUFxQjtBQUNoQ0MsRUFBQUEsS0FBSyxFQUFFLE1BRHlCO0FBRWhDQyxFQUFBQSxVQUFVLEVBQUUsQ0FDVixJQUFJSCxRQUFPLENBQUNHLFVBQVIsQ0FBbUJDLE9BQXZCLEVBRFUsQ0FGb0I7QUFLaENDLEVBQUFBLE1BQU0sRUFBRUwsUUFBTyxDQUFDSyxNQUFSLENBQWVDLE9BQWYsQ0FDSk4sUUFBTyxDQUFDSyxNQUFSLENBQWUsQ0FBQ0UsSUFBRCxFQUFPQyxJQUFQLEtBQWdCQyxNQUFNLENBQUNDLE1BQVAsQ0FBY0gsSUFBZCxFQUFvQjtBQUFDSSxJQUFBQSxNQUFNLEVBQUVDO0FBQVQsR0FBcEIsQ0FBL0IsR0FESSxFQUVKWixRQUFPLENBQUNLLE1BQVIsQ0FBZVEsTUFBZixDQUFzQjtBQUFDQyxJQUFBQSxLQUFLLEVBQUU7QUFBUixHQUF0QixDQUZJLEVBR0pDLGdCQUFpQixFQUhiLEVBSUpmLFFBQU8sQ0FBQ0ssTUFBUixDQUFlVyxJQUFmLEVBSkk7QUFMd0IsQ0FBckIsQ0FBZjs7QUFZQSxNQUFNQyxJQUFJLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRixJQUF6QjtBQUNBLE1BQU1HLFFBQVEsR0FBR0YsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFFBQTdCOztBQUVBLE1BQU1DLElBQUksR0FBR0MsTUFBSyxDQUFDQyxVQUFOLENBQWlCO0FBQzFCQyxFQUFBQSxJQUFJLEVBQUVQLElBRG9CO0FBRTFCUSxFQUFBQSxJQUFJLEVBQUUsTUFGb0I7QUFHMUJDLEVBQUFBLElBQUksRUFBRSxPQUhvQjtBQUkx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SCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZXdyZWxpYyBmcm9tICduZXdyZWxpYyc7XG5pbXBvcnQgeyBjb25uZWN0IH0gZnJvbSAnaHR0cDInO1xuaW1wb3J0IG15c3FsIGZyb20gJ215c3FsMidcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJ1xuaW1wb3J0IEZvcm1EYXRhIGZyb20gJ2Zvcm0tZGF0YSdcbmltcG9ydCB3aW5zdG9uIGZyb20gJ3dpbnN0b24nXG5pbXBvcnQgbmV3cmVsaWNGb3JtYXR0ZXIgZnJvbSAnQG5ld3JlbGljL3dpbnN0b24tZW5yaWNoZXInXG5cbmNvbnN0IGxvZ2dlciA9IHdpbnN0b24uY3JlYXRlTG9nZ2VyKHtcbiAgICBsZXZlbDogJ2luZm8nLFxuICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSgpXG4gICAgXSxcbiAgICBmb3JtYXQ6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUoXG4gICAgICAgIHdpbnN0b24uZm9ybWF0KChpbmZvLCBvcHRzKSA9PiBPYmplY3QuYXNzaWduKGluZm8sIHttb2R1bGU6IF9fZmlsZW5hbWV9KSkoKSxcbiAgICAgICAgd2luc3Rvbi5mb3JtYXQuZXJyb3JzKHtzdGFjazogdHJ1ZX0pLFxuICAgICAgICBuZXdyZWxpY0Zvcm1hdHRlcigpLFxuICAgICAgICB3aW5zdG9uLmZvcm1hdC5qc29uKClcbiAgICApXG4gIH0pO1xuY29uc3QgSE9TVCA9IHByb2Nlc3MuZW52LkhPU1Q7XG5jb25zdCBQQVNTV09SRCA9IHByb2Nlc3MuZW52LlBBU1NXT1JEO1xuXG5jb25zdCBwb29sID0gbXlzcWwuY3JlYXRlUG9vbCh7XG4gICAgaG9zdDogSE9TVCxcbiAgICBwb3J0OiAnMzMwNicsXG4gICAgdXNlcjogXCJhZG1pblwiLFxuICAgIHBhc3N3b3JkOiBQQVNTV09SRCxcbiAgICB3YWl0Rm9yQ29ubmVjdGlvbnM6IHRydWUsXG4gICAgY29ubmVjdGlvbkxpbWl0OiAxMCxcbiAgICBxdWV1ZUxpbWl0OiAzXG59KTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxpc3RQaWN0dXJlcygpIHtcbiAgICB2YXIgc3FsID0gXCJTRUxFQ1QgKiBGUk9NIG1haW4uaW1hZ2VzIFdIRVJFIGFwcHJvdmU9J3RydWUnXCI7XG4gICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IHBvb2wucHJvbWlzZSgpLnF1ZXJ5KHNxbClcbiAgICByZXR1cm4gcmVzdWx0c1xufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRvd25sb2FkQnVmZmVyKHVybCkge1xuICAgIGxldCByZXNwID0gYXdhaXQgZmV0Y2godXJsLHtcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICB9KVxuXG4gICAgLy8gcmVjZWl2ZSB0aGUgcmVzcG9uc2VcbiAgICBsZXQgZGF0YSA9IGF3YWl0IHJlc3AuYXJyYXlCdWZmZXIoKVxuICAgIHJldHVybiBkYXRhXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRTcGVjaWZpY0hhdChzdHlsZSkge1xuICAgIHZhciBzcWwgPSBgU0VMRUNUICogRlJPTSBtYWluLmltYWdlcyBXSEVSRSBCSU5BUlkgZGVzY3JpcHRpb249JyR7c3R5bGV9JyBBTkQgYXBwcm92ZT0ndHJ1ZSdgO1xuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBwb29sLnByb21pc2UoKS5xdWVyeShzcWwpXG4gICAgICAgIC5jYXRjaChlcnIgPT4gbG9nZ2VyLmVycm9yKGVycikpXG4gICAgLy9sb2dnZXIuaW5mbyhgZ2V0U3BlY2lmaWNIYXQgcmVzdWx0czogJHtKU09OLnN0cmluZ2lmeShyZXN1bHRzKX1gKTtcbiAgICBsZXQgaGF0TGlzdCA9IHJlc3VsdHNbMF1cbiAgICAvL2xvZ2dlci5pbmZvKGBoYXRMaXN0OiAke0pTT04uc3RyaW5naWZ5KGhhdExpc3QpfWApXG4gICAgaWYgKGhhdExpc3QubGVuZ3RoID09IDApe1xuICAgICAgICByZXR1cm4gbnVsbFxuICAgIH1cblxuICAgIGxldCByYW5kTnVtID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogaGF0TGlzdC5sZW5ndGgpXG4gICAgbGV0IGhhdCA9IGhhdExpc3RbcmFuZE51bV07XG4gICAgbGV0IGhhdExpbmsgPSBoYXQudXJsXG4gICAgbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdzdHlsZScsIGhhdC5kZXNjcmlwdGlvbik7XG4gICAgbG9nZ2VyLmluZm8oYGhhdExpbms6ICR7aGF0TGlua31gKVxuXG4gICAgbGV0IGltYWdlID0gYXdhaXQgZG93bmxvYWRCdWZmZXIoaGF0TGluaylcbiAgICBpbWFnZSA9IEJ1ZmZlci5mcm9tKGltYWdlKVxuXG4gICAgcmV0dXJuIGltYWdlXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRIYXREYXRhKCkge1xuICAgIHZhciBzcWwgPSBgU0VMRUNUIGRlc2NyaXB0aW9uLCB1cmwgRlJPTSBtYWluLmltYWdlcyBXSEVSRSBhcHByb3ZlPSd0cnVlJ2A7XG4gICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IHBvb2wucHJvbWlzZSgpLnF1ZXJ5KHNxbClcbiAgICAvL2xvZ2dlci5pbmZvKGBnZXRoYXRkYXRhIHJlc3VsdHM6ICR7cmVzdWx0c31gKTtcbiAgICBsZXQgaGF0TGlzdCA9IHJlc3VsdHNbMF1cbiAgICAvL2xvZ2dlci5pbmZvKGhhdExpc3QpXG5cbiAgICByZXR1cm4gaGF0TGlzdFxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UmFuZG9tSGF0KCkge1xuICAgIC8vIGdldCByYW5kb20gaGF0IHBpY3R1cmVcbiAgICBsZXQgaGF0cyA9IGF3YWl0IGxpc3RQaWN0dXJlcygpXG4gICAgbGV0IGhhdExpc3QgPSBoYXRzWzBdXG4gICAgLy9sb2dnZXIuaW5mbyhgZ2V0UmFuZG9tSGF0IGhhdGxpc3RMICR7aGF0TGlzdH1gKTtcblxuICAgIGxldCByYW5kTnVtID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogaGF0TGlzdC5sZW5ndGgpXG4gICAgbGV0IGhhdCA9IGhhdExpc3RbcmFuZE51bV07XG4gICAgbGV0IGhhdExpbmsgPSBoYXQudXJsO1xuICAgIG5ld3JlbGljLmFkZEN1c3RvbUF0dHJpYnV0ZSgnc3R5bGUnLCBoYXQuZGVzY3JpcHRpb24pO1xuICAgIGxvZ2dlci5pbmZvKGBnZXRSYW5kb21IYXQgaGF0TGluayAke2hhdExpbmt9YCk7XG5cbiAgICBsZXQgaW1hZ2UgPSBhd2FpdCBkb3dubG9hZEJ1ZmZlcihoYXRMaW5rKVxuICAgIGltYWdlID0gQnVmZmVyLmZyb20oaW1hZ2UpXG4gICAgcmV0dXJuIGltYWdlXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWZhdWx0Qm9zcygpIHtcbiAgICAvL215IGZhdiBib3NzIGV2ZXJcbiAgICBsZXQgam9obktpbm1vbnRoID0gYXdhaXQgZG93bmxvYWRCdWZmZXIoXCJodHRwczovL3VzZXItaW1hZ2VzLmdpdGh1YnVzZXJjb250ZW50LmNvbS82OTMzMjk2NC8xMjg2NDUxNDMtODY0MDVhNjItNjkxYi00ZGU5LTg1MDAtYjkzNjI2NzVlMWRiLnBuZ1wiKTtcbiAgICBqb2huS2lubW9udGggPSBCdWZmZXIuZnJvbShqb2huS2lubW9udGgpXG5cbiAgICByZXR1cm4gam9obktpbm1vbnRoXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXF1ZXN0TWFuaXB1bGF0ZShmYWNlLCBoYXQsIG51bWJlckhhdHMpIHtcbiAgICAvLyBoaXQgdGhlIHVwbG9hZCBlbmRwb2ludCB0byB1cGxvYWQgaW1hZ2UgYW5kIHJldHJpZXZlIHVuaXF1ZSBpbWFnZSBpZFxuICAgIGxldCBmYWNlRGF0YSA9IGZhY2VcbiAgICBmb3IgKHZhciBpID0gbnVtYmVySGF0czsgaSA+PSAxOyBpLS0pIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oYEFwcGx5aW5nIGhhdCAke2l9IG9mICR7bnVtYmVySGF0c31gKVxuICAgICAgICBsZXQgdHJhbnNsYXRlID0gaSowLjZcbiAgICAgICAgbGV0IHJvdGF0ZSA9IGkqMTBcbiAgICAgICAgbGV0IGZvcm1EYXRhID0gYXdhaXQgY3JlYXRlRm9ybShmYWNlRGF0YSwgaGF0KVxuICAgICAgICBjb25zdCBmb3JtSGVhZGVycyA9IGZvcm1EYXRhLmdldEhlYWRlcnMoKTtcbiAgICAgICAgY29uc3QgbWFuVXJsID0gYGh0dHA6Ly8ke3Byb2Nlc3MuZW52Lk1BTklQVUxBVEVfRU5EUE9JTlR9L21hbmlwdWxhdGU/dHJhbnNsYXRlPSR7dHJhbnNsYXRlfSZyb3RhdGU9JHtyb3RhdGV9YDtcbiAgICAgICAgbG9nZ2VyLmluZm8oYFBPU1QgJHttYW5Vcmx9YClcbiAgICAgICAgY29uc3QgbWFuaXB1bGF0ZVJlcXVlc3QgPSBhd2FpdCBmZXRjaChtYW5VcmwsIHtcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgYm9keTogZm9ybURhdGEsXG4gICAgICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgIC4uLmZvcm1IZWFkZXJzLFxuICAgICAgICAgICAgICAgIH0sICAgICAgICBcbiAgICAgICAgfSk7XG4gICAgXG4gICAgICAgIHZhciBiNjRSZXN1bHQgPSBhd2FpdCBtYW5pcHVsYXRlUmVxdWVzdC5qc29uKClcblxuICAgICAgICBpZiAoaSA9PSAxKSB7XG4gICAgICAgICAgICBmYWNlRGF0YSA9IGI2NFJlc3VsdFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZmFjZURhdGEgPSBCdWZmZXIuZnJvbShiNjRSZXN1bHQuZmluYWxCYWJ5LnJlcGxhY2UoXCJkYXRhOmltYWdlL3BuZztiYXNlNjQsXCIsIFwiXCIpLCBcImJhc2U2NFwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxvZ2dlci5pbmZvKGBSZWNlaXZlZCByZXNwb25zZSBmcm9tIC9tYW5pcHVsYXRlIFtoYXQgJHtpfV1gKVxuICAgIH1cblxuICAgIHJldHVybiBmYWNlRGF0YVxufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVGb3JtKGZhY2UsIGhhdCkge1xuICAgIGxldCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpXG4gICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgZmFjZSwge2ZpbGVuYW1lOiBcImZhY2VcIiwgZGF0YTogZmFjZX0pXG4gICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgaGF0LCB7ZmlsZW5hbWU6IFwiaGF0XCIsIGRhdGE6IGhhdH0pXG5cbiAgICByZXR1cm4gZm9ybURhdGFcbn0iXX0=