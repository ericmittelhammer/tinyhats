"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.defaultBoss = defaultBoss;
exports.downloadBuffer = downloadBuffer;
exports.getHatData = getHatData;
exports.getRandomHat = getRandomHat;
exports.getSpecificHat = getSpecificHat;
exports.listPictures = listPictures;
exports.requestManipulate = requestManipulate;

var _newrelic = require("newrelic");

var _http = require("http2");

var _mysql = require("mysql2");

var _nodeFetch = require("node-fetch");

var _formData = require("form-data");

var _winston = require("winston");

var _winstonEnricher = require("@newrelic/winston-enricher");

const logger = _winston.createLogger({
  level: 'info',
  transports: [new _winston.transports.Console()],
  format: _winston.format.combine(_winston.format((info, opts) => Object.assign(info, {
    module: __filename
  }))(), _winston.format.errors({
    stack: true
  }), _winstonEnricher(), _winston.format.json())
});

const HOST = process.env.HOST;
const PASSWORD = process.env.PASSWORD;

const pool = _mysql.createPool({
  host: HOST,
  port: '3306',
  user: "admin",
  password: PASSWORD,
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 3
});

async function listPictures() {
  var sql = "SELECT * FROM main.images WHERE approve='true'";
  const results = await pool.promise().query(sql);
  return results;
}

;

async function downloadBuffer(url) {
  let resp = await _nodeFetch(url, {
    method: 'GET'
  }); // receive the response

  let data = await resp.arrayBuffer();
  return data;
}

async function getSpecificHat(style) {
  var sql = `SELECT * FROM main.images WHERE BINARY description='${style}' AND approve='true'`;
  const results = await pool.promise().query(sql).catch(err => logger.error(err)); //logger.info(`getSpecificHat results: ${JSON.stringify(results)}`);

  let hatList = results[0]; //logger.info(`hatList: ${JSON.stringify(hatList)}`)

  if (hatList.length == 0) {
    return null;
  }

  let randNum = Math.floor(Math.random() * hatList.length);
  let hat = hatList[randNum];
  let hatLink = hat.url;

  _newrelic.addCustomAttribute('style', 'goop');

  logger.info(`hatLink: ${hatLink}`);
  let image = await downloadBuffer(hatLink);
  image = Buffer.from(image);
  return image;
}

async function getHatData() {
  var sql = `SELECT description, url FROM main.images WHERE approve='true'`;
  const results = await pool.promise().query(sql); //logger.info(`gethatdata results: ${results}`);

  let hatList = results[0]; //logger.info(hatList)

  return hatList;
}

async function getRandomHat() {
  // get random hat picture
  let hats = await listPictures();
  let hatList = hats[0]; //logger.info(`getRandomHat hatlistL ${hatList}`);

  let randNum = Math.floor(Math.random() * hatList.length);
  let hat = hatList[randNum];
  let hatLink = hat.url;

  _newrelic.addCustomAttribute('style', hat.description);

  logger.info(`getRandomHat hatLink ${hatLink}`);
  let image = await downloadBuffer(hatLink);
  image = Buffer.from(image);
  return image;
}

async function defaultBoss() {
  //my fav boss ever
  let johnKinmonth = await downloadBuffer("https://user-images.githubusercontent.com/69332964/128645143-86405a62-691b-4de9-8500-b9362675e1db.png");
  johnKinmonth = Buffer.from(johnKinmonth);
  return johnKinmonth;
}

async function requestManipulate(face, hat, numberHats) {
  // hit the upload endpoint to upload image and retrieve unique image id
  let faceData = face;

  for (var i = numberHats; i >= 1; i--) {
    logger.info(`Applying hat ${i} of ${numberHats}`);
    let translate = i * 0.6;
    let rotate = i * 10;
    let formData = await createForm(faceData, hat);
    const formHeaders = formData.getHeaders();
    const manUrl = `http://${process.env.MANIPULATE_ENDPOINT}/manipulate?translate=${translate}&rotate=${rotate}`;
    logger.info(`POST ${manUrl}`);
    const manipulateRequest = await _nodeFetch(manUrl, {
      method: 'POST',
      body: formData,
      headers: { ...formHeaders
      }
    });
    var b64Result = await manipulateRequest.json();

    if (i == 1) {
      faceData = b64Result;
    } else {
      faceData = Buffer.from(b64Result.finalBaby.replace("data:image/png;base64,", ""), "base64");
    }

    logger.info(`Received response from /manipulate [hat ${i}]`);
  }

  return faceData;
}

async function createForm(face, hat) {
  let formData = new _formData();
  formData.append('file', face, {
    filename: "face",
    data: face
  });
  formData.append('file', hat, {
    filename: "hat",
    data: hat
  });
  return formData;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsIndpbnN0b24iLCJjcmVhdGVMb2dnZXIiLCJsZXZlbCIsInRyYW5zcG9ydHMiLCJDb25zb2xlIiwiZm9ybWF0IiwiY29tYmluZSIsImluZm8iLCJvcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwibW9kdWxlIiwiX19maWxlbmFtZSIsImVycm9ycyIsInN0YWNrIiwibmV3cmVsaWNGb3JtYXR0ZXIiLCJqc29uIiwiSE9TVCIsInByb2Nlc3MiLCJlbnYiLCJQQVNTV09SRCIsInBvb2wiLCJteXNxbCIsImNyZWF0ZVBvb2wiLCJob3N0IiwicG9ydCIsInVzZXIiLCJwYXNzd29yZCIsIndhaXRGb3JDb25uZWN0aW9ucyIsImNvbm5lY3Rpb25MaW1pdCIsInF1ZXVlTGltaXQiLCJsaXN0UGljdHVyZXMiLCJzcWwiLCJyZXN1bHRzIiwicHJvbWlzZSIsInF1ZXJ5IiwiZG93bmxvYWRCdWZmZXIiLCJ1cmwiLCJyZXNwIiwiZmV0Y2giLCJtZXRob2QiLCJkYXRhIiwiYXJyYXlCdWZmZXIiLCJnZXRTcGVjaWZpY0hhdCIsInN0eWxlIiwiY2F0Y2giLCJlcnIiLCJlcnJvciIsImhhdExpc3QiLCJsZW5ndGgiLCJyYW5kTnVtIiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwiaGF0IiwiaGF0TGluayIsIm5ld3JlbGljIiwiYWRkQ3VzdG9tQXR0cmlidXRlIiwiaW1hZ2UiLCJCdWZmZXIiLCJmcm9tIiwiZ2V0SGF0RGF0YSIsImdldFJhbmRvbUhhdCIsImhhdHMiLCJkZXNjcmlwdGlvbiIsImRlZmF1bHRCb3NzIiwiam9obktpbm1vbnRoIiwicmVxdWVzdE1hbmlwdWxhdGUiLCJmYWNlIiwibnVtYmVySGF0cyIsImZhY2VEYXRhIiwiaSIsInRyYW5zbGF0ZSIsInJvdGF0ZSIsImZvcm1EYXRhIiwiY3JlYXRlRm9ybSIsImZvcm1IZWFkZXJzIiwiZ2V0SGVhZGVycyIsIm1hblVybCIsIk1BTklQVUxBVEVfRU5EUE9JTlQiLCJtYW5pcHVsYXRlUmVxdWVzdCIsImJvZHkiLCJoZWFkZXJzIiwiYjY0UmVzdWx0IiwiZmluYWxCYWJ5IiwicmVwbGFjZSIsIkZvcm1EYXRhIiwiYXBwZW5kIiwiZmlsZW5hbWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxNQUFNLEdBQUdDLFFBQU8sQ0FBQ0MsWUFBUixDQUFxQjtBQUNoQ0MsRUFBQUEsS0FBSyxFQUFFLE1BRHlCO0FBRWhDQyxFQUFBQSxVQUFVLEVBQUUsQ0FDVixJQUFJSCxRQUFPLENBQUNHLFVBQVIsQ0FBbUJDLE9BQXZCLEVBRFUsQ0FGb0I7QUFLaENDLEVBQUFBLE1BQU0sRUFBRUwsUUFBTyxDQUFDSyxNQUFSLENBQWVDLE9BQWYsQ0FDSk4sUUFBTyxDQUFDSyxNQUFSLENBQWUsQ0FBQ0UsSUFBRCxFQUFPQyxJQUFQLEtBQWdCQyxNQUFNLENBQUNDLE1BQVAsQ0FBY0gsSUFBZCxFQUFvQjtBQUFDSSxJQUFBQSxNQUFNLEVBQUVDO0FBQVQsR0FBcEIsQ0FBL0IsR0FESSxFQUVKWixRQUFPLENBQUNLLE1BQVIsQ0FBZVEsTUFBZixDQUFzQjtBQUFDQyxJQUFBQSxLQUFLLEVBQUU7QUFBUixHQUF0QixDQUZJLEVBR0pDLGdCQUFpQixFQUhiLEVBSUpmLFFBQU8sQ0FBQ0ssTUFBUixDQUFlVyxJQUFmLEVBSkk7QUFMd0IsQ0FBckIsQ0FBZjs7QUFZQSxNQUFNQyxJQUFJLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRixJQUF6QjtBQUNBLE1BQU1HLFFBQVEsR0FBR0YsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFFBQTdCOztBQUVBLE1BQU1DLElBQUksR0FBR0MsTUFBSyxDQUFDQyxVQUFOLENBQWlCO0FBQzFCQyxFQUFBQSxJQUFJLEVBQUVQLElBRG9CO0FBRTFCUSxFQUFBQSxJQUFJLEVBQUUsTUFGb0I7QUFHMUJDLEVBQUFBLElBQUksRUFBRSxPQUhvQjtBQUkx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bnRlbnQiOlsiaW1wb3J0IG5ld3JlbGljIGZyb20gJ25ld3JlbGljJztcbmltcG9ydCB7IGNvbm5lY3QgfSBmcm9tICdodHRwMic7XG5pbXBvcnQgbXlzcWwgZnJvbSAnbXlzcWwyJ1xuaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnXG5pbXBvcnQgRm9ybURhdGEgZnJvbSAnZm9ybS1kYXRhJ1xuaW1wb3J0IHdpbnN0b24gZnJvbSAnd2luc3RvbidcbmltcG9ydCBuZXdyZWxpY0Zvcm1hdHRlciBmcm9tICdAbmV3cmVsaWMvd2luc3Rvbi1lbnJpY2hlcidcblxuY29uc3QgbG9nZ2VyID0gd2luc3Rvbi5jcmVhdGVMb2dnZXIoe1xuICAgIGxldmVsOiAnaW5mbycsXG4gICAgdHJhbnNwb3J0czogW1xuICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKClcbiAgICBdLFxuICAgIGZvcm1hdDogd2luc3Rvbi5mb3JtYXQuY29tYmluZShcbiAgICAgICAgd2luc3Rvbi5mb3JtYXQoKGluZm8sIG9wdHMpID0+IE9iamVjdC5hc3NpZ24oaW5mbywge21vZHVsZTogX19maWxlbmFtZX0pKSgpLFxuICAgICAgICB3aW5zdG9uLmZvcm1hdC5lcnJvcnMoe3N0YWNrOiB0cnVlfSksXG4gICAgICAgIG5ld3JlbGljRm9ybWF0dGVyKCksXG4gICAgICAgIHdpbnN0b24uZm9ybWF0Lmpzb24oKVxuICAgIClcbiAgfSk7XG5jb25zdCBIT1NUID0gcHJvY2Vzcy5lbnYuSE9TVDtcbmNvbnN0IFBBU1NXT1JEID0gcHJvY2Vzcy5lbnYuUEFTU1dPUkQ7XG5cbmNvbnN0IHBvb2wgPSBteXNxbC5jcmVhdGVQb29sKHtcbiAgICBob3N0OiBIT1NULFxuICAgIHBvcnQ6ICczMzA2JyxcbiAgICB1c2VyOiBcImFkbWluXCIsXG4gICAgcGFzc3dvcmQ6IFBBU1NXT1JELFxuICAgIHdhaXRGb3JDb25uZWN0aW9uczogdHJ1ZSxcbiAgICBjb25uZWN0aW9uTGltaXQ6IDEwLFxuICAgIHF1ZXVlTGltaXQ6IDNcbn0pO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGlzdFBpY3R1cmVzKCkge1xuICAgIHZhciBzcWwgPSBcIlNFTEVDVCAqIEZST00gbWFpbi5pbWFnZXMgV0hFUkUgYXBwcm92ZT0ndHJ1ZSdcIjtcbiAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgcG9vbC5wcm9taXNlKCkucXVlcnkoc3FsKVxuICAgIHJldHVybiByZXN1bHRzXG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRCdWZmZXIodXJsKSB7XG4gICAgbGV0IHJlc3AgPSBhd2FpdCBmZXRjaCh1cmwse1xuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgIH0pXG5cbiAgICAvLyByZWNlaXZlIHRoZSByZXNwb25zZVxuICAgIGxldCBkYXRhID0gYXdhaXQgcmVzcC5hcnJheUJ1ZmZlcigpXG4gICAgcmV0dXJuIGRhdGFcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNwZWNpZmljSGF0KHN0eWxlKSB7XG4gICAgdmFyIHNxbCA9IGBTRUxFQ1QgKiBGUk9NIG1haW4uaW1hZ2VzIFdIRVJFIEJJTkFSWSBkZXNjcmlwdGlvbj0nJHtzdHlsZX0nIEFORCBhcHByb3ZlPSd0cnVlJ2A7XG4gICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IHBvb2wucHJvbWlzZSgpLnF1ZXJ5KHNxbClcbiAgICAgICAgLmNhdGNoKGVyciA9PiBsb2dnZXIuZXJyb3IoZXJyKSlcbiAgICAvL2xvZ2dlci5pbmZvKGBnZXRTcGVjaWZpY0hhdCByZXN1bHRzOiAke0pTT04uc3RyaW5naWZ5KHJlc3VsdHMpfWApO1xuICAgIGxldCBoYXRMaXN0ID0gcmVzdWx0c1swXVxuICAgIC8vbG9nZ2VyLmluZm8oYGhhdExpc3Q6ICR7SlNPTi5zdHJpbmdpZnkoaGF0TGlzdCl9YClcbiAgICBpZiAoaGF0TGlzdC5sZW5ndGggPT0gMCl7XG4gICAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgbGV0IHJhbmROdW0gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBoYXRMaXN0Lmxlbmd0aClcbiAgICBsZXQgaGF0ID0gaGF0TGlzdFtyYW5kTnVtXTtcbiAgICBsZXQgaGF0TGluayA9IGhhdC51cmxcbiAgICBuZXdyZWxpYy5hZGRDdXN0b21BdHRyaWJ1dGUoJ3N0eWxlJywgJ2dvb3AnKTtcbiAgICBsb2dnZXIuaW5mbyhgaGF0TGluazogJHtoYXRMaW5rfWApXG5cbiAgICBsZXQgaW1hZ2UgPSBhd2FpdCBkb3dubG9hZEJ1ZmZlcihoYXRMaW5rKVxuICAgIGltYWdlID0gQnVmZmVyLmZyb20oaW1hZ2UpXG5cbiAgICByZXR1cm4gaW1hZ2Vcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEhhdERhdGEoKSB7XG4gICAgdmFyIHNxbCA9IGBTRUxFQ1QgZGVzY3JpcHRpb24sIHVybCBGUk9NIG1haW4uaW1hZ2VzIFdIRVJFIGFwcHJvdmU9J3RydWUnYDtcbiAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgcG9vbC5wcm9taXNlKCkucXVlcnkoc3FsKVxuICAgIC8vbG9nZ2VyLmluZm8oYGdldGhhdGRhdGEgcmVzdWx0czogJHtyZXN1bHRzfWApO1xuICAgIGxldCBoYXRMaXN0ID0gcmVzdWx0c1swXVxuICAgIC8vbG9nZ2VyLmluZm8oaGF0TGlzdClcblxuICAgIHJldHVybiBoYXRMaXN0XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRSYW5kb21IYXQoKSB7XG4gICAgLy8gZ2V0IHJhbmRvbSBoYXQgcGljdHVyZVxuICAgIGxldCBoYXRzID0gYXdhaXQgbGlzdFBpY3R1cmVzKClcbiAgICBsZXQgaGF0TGlzdCA9IGhhdHNbMF1cbiAgICAvL2xvZ2dlci5pbmZvKGBnZXRSYW5kb21IYXQgaGF0bGlzdEwgJHtoYXRMaXN0fWApO1xuXG4gICAgbGV0IHJhbmROdW0gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBoYXRMaXN0Lmxlbmd0aClcbiAgICBsZXQgaGF0ID0gaGF0TGlzdFtyYW5kTnVtXTtcbiAgICBsZXQgaGF0TGluayA9IGhhdC51cmw7XG4gICAgbmV3cmVsaWMuYWRkQ3VzdG9tQXR0cmlidXRlKCdzdHlsZScsIGhhdC5kZXNjcmlwdGlvbik7XG4gICAgbG9nZ2VyLmluZm8oYGdldFJhbmRvbUhhdCBoYXRMaW5rICR7aGF0TGlua31gKTtcblxuICAgIGxldCBpbWFnZSA9IGF3YWl0IGRvd25sb2FkQnVmZmVyKGhhdExpbmspXG4gICAgaW1hZ2UgPSBCdWZmZXIuZnJvbShpbWFnZSlcbiAgICByZXR1cm4gaW1hZ2Vcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlZmF1bHRCb3NzKCkge1xuICAgIC8vbXkgZmF2IGJvc3MgZXZlclxuICAgIGxldCBqb2huS2lubW9udGggPSBhd2FpdCBkb3dubG9hZEJ1ZmZlcihcImh0dHBzOi8vdXNlci1pbWFnZXMuZ2l0aHVidXNlcmNvbnRlbnQuY29tLzY5MzMyOTY0LzEyODY0NTE0My04NjQwNWE2Mi02OTFiLTRkZTktODUwMC1iOTM2MjY3NWUxZGIucG5nXCIpO1xuICAgIGpvaG5LaW5tb250aCA9IEJ1ZmZlci5mcm9tKGpvaG5LaW5tb250aClcblxuICAgIHJldHVybiBqb2huS2lubW9udGhcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcXVlc3RNYW5pcHVsYXRlKGZhY2UsIGhhdCwgbnVtYmVySGF0cykge1xuICAgIC8vIGhpdCB0aGUgdXBsb2FkIGVuZHBvaW50IHRvIHVwbG9hZCBpbWFnZSBhbmQgcmV0cmlldmUgdW5pcXVlIGltYWdlIGlkXG4gICAgbGV0IGZhY2VEYXRhID0gZmFjZVxuICAgIGZvciAodmFyIGkgPSBudW1iZXJIYXRzOyBpID49IDE7IGktLSkge1xuICAgICAgICBsb2dnZXIuaW5mbyhgQXBwbHlpbmcgaGF0ICR7aX0gb2YgJHtudW1iZXJIYXRzfWApXG4gICAgICAgIGxldCB0cmFuc2xhdGUgPSBpKjAuNlxuICAgICAgICBsZXQgcm90YXRlID0gaSoxMFxuICAgICAgICBsZXQgZm9ybURhdGEgPSBhd2FpdCBjcmVhdGVGb3JtKGZhY2VEYXRhLCBoYXQpXG4gICAgICAgIGNvbnN0IGZvcm1IZWFkZXJzID0gZm9ybURhdGEuZ2V0SGVhZGVycygpO1xuICAgICAgICBjb25zdCBtYW5VcmwgPSBgaHR0cDovLyR7cHJvY2Vzcy5lbnYuTUFOSVBVTEFURV9FTkRQT0lOVH0vbWFuaXB1bGF0ZT90cmFuc2xhdGU9JHt0cmFuc2xhdGV9JnJvdGF0ZT0ke3JvdGF0ZX1gO1xuICAgICAgICBsb2dnZXIuaW5mbyhgUE9TVCAke21hblVybH1gKVxuICAgICAgICBjb25zdCBtYW5pcHVsYXRlUmVxdWVzdCA9IGF3YWl0IGZldGNoKG1hblVybCwge1xuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBib2R5OiBmb3JtRGF0YSxcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgLi4uZm9ybUhlYWRlcnMsXG4gICAgICAgICAgICAgICAgfSwgICAgICAgIFxuICAgICAgICB9KTtcbiAgICBcbiAgICAgICAgdmFyIGI2NFJlc3VsdCA9IGF3YWl0IG1hbmlwdWxhdGVSZXF1ZXN0Lmpzb24oKVxuXG4gICAgICAgIGlmIChpID09IDEpIHtcbiAgICAgICAgICAgIGZhY2VEYXRhID0gYjY0UmVzdWx0XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmYWNlRGF0YSA9IEJ1ZmZlci5mcm9tKGI2NFJlc3VsdC5maW5hbEJhYnkucmVwbGFjZShcImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxcIiwgXCJcIiksIFwiYmFzZTY0XCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nZ2VyLmluZm8oYFJlY2VpdmVkIHJlc3BvbnNlIGZyb20gL21hbmlwdWxhdGUgW2hhdCAke2l9XWApXG4gICAgfVxuXG4gICAgcmV0dXJuIGZhY2VEYXRhXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUZvcm0oZmFjZSwgaGF0KSB7XG4gICAgbGV0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKClcbiAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCBmYWNlLCB7ZmlsZW5hbWU6IFwiZmFjZVwiLCBkYXRhOiBmYWNlfSlcbiAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCBoYXQsIHtmaWxlbmFtZTogXCJoYXRcIiwgZGF0YTogaGF0fSlcblxuICAgIHJldHVybiBmb3JtRGF0YVxufSJdfQ==