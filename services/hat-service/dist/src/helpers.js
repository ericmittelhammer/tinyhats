"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.defaultBoss = defaultBoss;
exports.downloadBuffer = downloadBuffer;
exports.getHatData = getHatData;
exports.getRandomHat = getRandomHat;
exports.getSpecificHat = getSpecificHat;
exports.listPictures = listPictures;
exports.requestManipulate = requestManipulate;

var _newrelic = require("newrelic");

var _http = require("http2");

var _mysql = require("mysql2");

var _nodeFetch = require("node-fetch");

var _formData = require("form-data");

var _winston = require("winston");

var _winstonEnricher = require("@newrelic/winston-enricher");

const logger = _winston.createLogger({
  level: 'info',
  transports: [new _winston.transports.Console()],
  format: _winston.format.combine(_winston.format.label({
    module: 'helpers.js'
  }), _winstonEnricher(), _winston.format.json())
});

const HOST = process.env.HOST;
const PASSWORD = process.env.PASSWORD;

const con = _mysql.createConnection({
  host: HOST,
  port: '3306',
  user: "admin",
  password: PASSWORD
});

async function listPictures() {
  var sql = "SELECT * FROM main.images WHERE approve='true'";
  const results = await con.promise().query(sql);
  return results;
}

;

async function downloadBuffer(url) {
  let resp = await _nodeFetch(url, {
    method: 'GET'
  }); // receive the response

  let data = await resp.arrayBuffer();
  return data;
}

async function getSpecificHat(style) {
  var sql = `SELECT * FROM main.images WHERE BINARY description='${style}' AND approve='true'`;
  const results = await con.promise().query(sql).catch(err => logger.error(err)); //logger.info(`getSpecificHat results: ${JSON.stringify(results)}`);

  let hatList = results[0]; //logger.info(`hatList: ${JSON.stringify(hatList)}`)

  if (hatList.length == 0) {
    return null;
  }

  let randNum = Math.floor(Math.random() * hatList.length);
  let hat = hatList[randNum];
  let hatLink = hat.url;

  _newrelic.addCustomAttribute('style', 'goop');

  logger.info(`hatLink: ${hatLink}`);
  let image = await downloadBuffer(hatLink);
  image = Buffer.from(image);
  return image;
}

async function getHatData() {
  var sql = `SELECT description, url FROM main.images WHERE approve='true'`;
  const results = await con.promise().query(sql); //logger.info(`gethatdata results: ${results}`);

  let hatList = results[0]; //logger.info(hatList)

  return hatList;
}

async function getRandomHat() {
  // get random hat picture
  let hats = await listPictures();
  let hatList = hats[0]; //logger.info(`getRandomHat hatlistL ${hatList}`);

  let randNum = Math.floor(Math.random() * hatList.length);
  let hat = hatList[randNum];
  let hatLink = hat.url;

  _newrelic.addCustomAttribute('style', hat.description);

  logger.info(`getRandomHat hatLink ${hatLink}`);
  let image = await downloadBuffer(hatLink);
  image = Buffer.from(image);
  return image;
}

async function defaultBoss() {
  //my fav boss ever
  let johnKinmonth = await downloadBuffer("https://user-images.githubusercontent.com/69332964/128645143-86405a62-691b-4de9-8500-b9362675e1db.png");
  johnKinmonth = Buffer.from(johnKinmonth);
  return johnKinmonth;
}

async function requestManipulate(face, hat, numberHats) {
  // hit the upload endpoint to upload image and retrieve unique image id
  let faceData = face;
  logger.info("Start loop");
  logger.info(numberHats);

  for (var i = numberHats; i >= 1; i--) {
    logger.info(i);
    let translate = i * 0.6;
    let rotate = i * 10;
    let formData = await createForm(faceData, hat);
    const formHeaders = formData.getHeaders();
    const manipulateRequest = await _nodeFetch(`http://${process.env.MANIPULATE_ENDPOINT}/manipulate?translate=${translate}&rotate=${rotate}`, {
      method: 'POST',
      body: formData,
      headers: { ...formHeaders
      }
    });
    var b64Result = await manipulateRequest.json();

    if (i == 1) {
      faceData = b64Result;
    } else {
      faceData = Buffer.from(b64Result.finalBaby.replace("data:image/png;base64,", ""), "base64");
    }

    logger.info(`Received response from /manipulate [${i}]`);
  }

  return faceData;
}

async function createForm(face, hat) {
  let formData = new _formData();
  formData.append('file', face, {
    filename: "face",
    data: face
  });
  formData.append('file', hat, {
    filename: "hat",
    data: hat
  });
  logger.info("Posting to Manipulate");
  return formData;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsIndpbnN0b24iLCJjcmVhdGVMb2dnZXIiLCJsZXZlbCIsInRyYW5zcG9ydHMiLCJDb25zb2xlIiwiZm9ybWF0IiwiY29tYmluZSIsImxhYmVsIiwibW9kdWxlIiwibmV3cmVsaWNGb3JtYXR0ZXIiLCJqc29uIiwiSE9TVCIsInByb2Nlc3MiLCJlbnYiLCJQQVNTV09SRCIsImNvbiIsIm15c3FsIiwiY3JlYXRlQ29ubmVjdGlvbiIsImhvc3QiLCJwb3J0IiwidXNlciIsInBhc3N3b3JkIiwibGlzdFBpY3R1cmVzIiwic3FsIiwicmVzdWx0cyIsInByb21pc2UiLCJxdWVyeSIsImRvd25sb2FkQnVmZmVyIiwidXJsIiwicmVzcCIsImZldGNoIiwibWV0aG9kIiwiZGF0YSIsImFycmF5QnVmZmVyIiwiZ2V0U3BlY2lmaWNIYXQiLCJzdHlsZSIsImNhdGNoIiwiZXJyIiwiZXJyb3IiLCJoYXRMaXN0IiwibGVuZ3RoIiwicmFuZE51bSIsIk1hdGgiLCJmbG9vciIsInJhbmRvbSIsImhhdCIsImhhdExpbmsiLCJuZXdyZWxpYyIsImFkZEN1c3RvbUF0dHJpYnV0ZSIsImluZm8iLCJpbWFnZSIsIkJ1ZmZlciIsImZyb20iLCJnZXRIYXREYXRhIiwiZ2V0UmFuZG9tSGF0IiwiaGF0cyIsImRlc2NyaXB0aW9uIiwiZGVmYXVsdEJvc3MiLCJqb2huS2lubW9udGgiLCJyZXF1ZXN0TWFuaXB1bGF0ZSIsImZhY2UiLCJudW1iZXJIYXRzIiwiZmFjZURhdGEiLCJpIiwidHJhbnNsYXRlIiwicm90YXRlIiwiZm9ybURhdGEiLCJjcmVhdGVGb3JtIiwiZm9ybUhlYWRlcnMiLCJnZXRIZWFkZXJzIiwibWFuaXB1bGF0ZVJlcXVlc3QiLCJNQU5JUFVMQVRFX0VORFBPSU5UIiwiYm9keSIsImhlYWRlcnMiLCJiNjRSZXN1bHQiLCJmaW5hbEJhYnkiLCJyZXBsYWNlIiwiRm9ybURhdGEiLCJhcHBlbmQiLCJmaWxlbmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLE1BQU0sR0FBR0MsUUFBTyxDQUFDQyxZQUFSLENBQXFCO0FBQ2hDQyxFQUFBQSxLQUFLLEVBQUUsTUFEeUI7QUFFaENDLEVBQUFBLFVBQVUsRUFBRSxDQUNWLElBQUlILFFBQU8sQ0FBQ0csVUFBUixDQUFtQkMsT0FBdkIsRUFEVSxDQUZvQjtBQUtoQ0MsRUFBQUEsTUFBTSxFQUFFTCxRQUFPLENBQUNLLE1BQVIsQ0FBZUMsT0FBZixDQUNKTixRQUFPLENBQUNLLE1BQVIsQ0FBZUUsS0FBZixDQUFxQjtBQUFFQyxJQUFBQSxNQUFNLEVBQUU7QUFBVixHQUFyQixDQURJLEVBRUpDLGdCQUFpQixFQUZiLEVBR0pULFFBQU8sQ0FBQ0ssTUFBUixDQUFlSyxJQUFmLEVBSEk7QUFMd0IsQ0FBckIsQ0FBZjs7QUFXQSxNQUFNQyxJQUFJLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRixJQUF6QjtBQUNBLE1BQU1HLFFBQVEsR0FBR0YsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFFBQTdCOztBQUVBLE1BQU1DLEdBQUcsR0FBR0MsTUFBSyxDQUFDQyxnQkFBTixDQUF1QjtBQUMvQkMsRUFBQUEsSUFBSSxFQUFFUCxJQUR5QjtBQUUvQlEsRUFBQUEsSUFBSSxFQUFFLE1BRnlCO0FBRy9CQyxFQUFBQSxJQUFJLEVBQUUsT0FIeUI7QUFJL0JDLEVBQUFBLFFBQVEsRUFBRVA7QUFKcUIsQ0FBdkIsQ0FBWjs7QUFPTyxlQUFlUSxZQUFmLEdBQThCO0FBQ2pDLE1BQUlDLEdBQUcsR0FBRyxnREFBVjtBQUNBLFFBQU1DLE9BQU8sR0FBRyxNQUFNVCxHQUFHLENBQUNVLE9BQUosR0FBY0MsS0FBZCxDQUFvQkgsR0FBcEIsQ0FBdEI7QUFDQSxTQUFPQyxPQUFQO0FBQ0g7O0FBQUE7O0FBRU0sZUFBZUcsY0FBZixDQUE4QkMsR0FBOUIsRUFBbUM7QUFDdEMsTUFBSUMsSUFBSSxHQUFHLE1BQU1DLFVBQUssQ0FBQ0YsR0FBRCxFQUFLO0FBQ3ZCRyxJQUFBQSxNQUFNLEVBQUU7QUFEZSxHQUFMLENBQXRCLENBRHNDLENBS3RDOztBQUNBLE1BQUlDLElBQUksR0FBRyxNQUFNSCxJQUFJLENBQUNJLFdBQUwsRUFBakI7QUFDQSxTQUFPRCxJQUFQO0FBQ0g7O0FBRU0sZUFBZUUsY0FBZixDQUE4QkMsS0FBOUIsRUFBcUM7QUFDeEMsTUFBSVosR0FBRyxHQUFJLHVEQUFzRFksS0FBTSxzQkFBdkU7QUFDQSxRQUFNWCxPQUFPLEdBQUcsTUFBTVQsR0FBRyxDQUFDVSxPQUFKLEdBQWNDLEtBQWQsQ0FBb0JILEdBQXBCLEVBQ2pCYSxLQURpQixDQUNYQyxHQUFHLElBQUl0QyxNQUFNLENBQUN1QyxLQUFQLENBQWFELEdBQWIsQ0FESSxDQUF0QixDQUZ3QyxDQUl4Qzs7QUFDQSxNQUFJRSxPQUFPLEdBQUdmLE9BQU8sQ0FBQyxDQUFELENBQXJCLENBTHdDLENBTXhDOztBQUNBLE1BQUllLE9BQU8sQ0FBQ0MsTUFBUixJQUFrQixDQUF0QixFQUF3QjtBQUNwQixXQUFPLElBQVA7QUFDSDs7QUFFRCxNQUFJQyxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXRCxJQUFJLENBQUNFLE1BQUwsS0FBZ0JMLE9BQU8sQ0FBQ0MsTUFBbkMsQ0FBZDtBQUNBLE1BQUlLLEdBQUcsR0FBR04sT0FBTyxDQUFDRSxPQUFELENBQWpCO0FBQ0EsTUFBSUssT0FBTyxHQUFHRCxHQUFHLENBQUNqQixHQUFsQjs7QUFDQW1CLEVBQUFBLFNBQVEsQ0FBQ0Msa0JBQVQsQ0FBNEIsT0FBNUIsRUFBcUMsTUFBckM7O0FBQ0FqRCxFQUFBQSxNQUFNLENBQUNrRCxJQUFQLENBQWEsWUFBV0gsT0FBUSxFQUFoQztBQUVBLE1BQUlJLEtBQUssR0FBRyxNQUFNdkIsY0FBYyxDQUFDbUIsT0FBRCxDQUFoQztBQUNBSSxFQUFBQSxLQUFLLEdBQUdDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZRixLQUFaLENBQVI7QUFFQSxTQUFPQSxLQUFQO0FBQ0g7O0FBRU0sZUFBZUcsVUFBZixHQUE0QjtBQUMvQixNQUFJOUIsR0FBRyxHQUFJLCtEQUFYO0FBQ0EsUUFBTUMsT0FBTyxHQUFHLE1BQU1ULEdBQUcsQ0FBQ1UsT0FBSixHQUFjQyxLQUFkLENBQW9CSCxHQUFwQixDQUF0QixDQUYrQixDQUcvQjs7QUFDQSxNQUFJZ0IsT0FBTyxHQUFHZixPQUFPLENBQUMsQ0FBRCxDQUFyQixDQUorQixDQUsvQjs7QUFFQSxTQUFPZSxPQUFQO0FBQ0g7O0FBRU0sZUFBZWUsWUFBZixHQUE4QjtBQUNqQztBQUNBLE1BQUlDLElBQUksR0FBRyxNQUFNakMsWUFBWSxFQUE3QjtBQUNBLE1BQUlpQixPQUFPLEdBQUdnQixJQUFJLENBQUMsQ0FBRCxDQUFsQixDQUhpQyxDQUlqQzs7QUFFQSxNQUFJZCxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXRCxJQUFJLENBQUNFLE1BQUwsS0FBZ0JMLE9BQU8sQ0FBQ0MsTUFBbkMsQ0FBZDtBQUNBLE1BQUlLLEdBQUcsR0FBR04sT0FBTyxDQUFDRSxPQUFELENBQWpCO0FBQ0EsTUFBSUssT0FBTyxHQUFHRCxHQUFHLENBQUNqQixHQUFsQjs7QUFDQW1CLEVBQUFBLFNBQVEsQ0FBQ0Msa0JBQVQsQ0FBNEIsT0FBNUIsRUFBcUNILEdBQUcsQ0FBQ1csV0FBekM7O0FBQ0F6RCxFQUFBQSxNQUFNLENBQUNrRCxJQUFQLENBQWEsd0JBQXVCSCxPQUFRLEVBQTVDO0FBRUEsTUFBSUksS0FBSyxHQUFHLE1BQU12QixjQUFjLENBQUNtQixPQUFELENBQWhDO0FBQ0FJLEVBQUFBLEtBQUssR0FBR0MsTUFBTSxDQUFDQyxJQUFQLENBQVlGLEtBQVosQ0FBUjtBQUNBLFNBQU9BLEtBQVA7QUFDSDs7QUFFTSxlQUFlTyxXQUFmLEdBQTZCO0FBQ2hDO0FBQ0EsTUFBSUMsWUFBWSxHQUFHLE1BQU0vQixjQUFjLENBQUMsdUdBQUQsQ0FBdkM7QUFDQStCLEVBQUFBLFlBQVksR0FBR1AsTUFBTSxDQUFDQyxJQUFQLENBQVlNLFlBQVosQ0FBZjtBQUVBLFNBQU9BLFlBQVA7QUFDSDs7QUFFTSxlQUFlQyxpQkFBZixDQUFpQ0MsSUFBakMsRUFBdUNmLEdBQXZDLEVBQTRDZ0IsVUFBNUMsRUFBd0Q7QUFDM0Q7QUFDQSxNQUFJQyxRQUFRLEdBQUdGLElBQWY7QUFDQTdELEVBQUFBLE1BQU0sQ0FBQ2tELElBQVAsQ0FBWSxZQUFaO0FBQ0FsRCxFQUFBQSxNQUFNLENBQUNrRCxJQUFQLENBQVlZLFVBQVo7O0FBQ0EsT0FBSyxJQUFJRSxDQUFDLEdBQUdGLFVBQWIsRUFBeUJFLENBQUMsSUFBSSxDQUE5QixFQUFpQ0EsQ0FBQyxFQUFsQyxFQUFzQztBQUNsQ2hFLElBQUFBLE1BQU0sQ0FBQ2tELElBQVAsQ0FBWWMsQ0FBWjtBQUNBLFFBQUlDLFNBQVMsR0FBR0QsQ0FBQyxHQUFDLEdBQWxCO0FBQ0EsUUFBSUUsTUFBTSxHQUFHRixDQUFDLEdBQUMsRUFBZjtBQUNBLFFBQUlHLFFBQVEsR0FBRyxNQUFNQyxVQUFVLENBQUNMLFFBQUQsRUFBV2pCLEdBQVgsQ0FBL0I7QUFDQSxVQUFNdUIsV0FBVyxHQUFHRixRQUFRLENBQUNHLFVBQVQsRUFBcEI7QUFDQSxVQUFNQyxpQkFBaUIsR0FBRyxNQUFNeEMsVUFBSyxDQUFFLFVBQVNsQixPQUFPLENBQUNDLEdBQVIsQ0FBWTBELG1CQUFvQix5QkFBd0JQLFNBQVUsV0FBVUMsTUFBTyxFQUE5RixFQUFpRztBQUNsSWxDLE1BQUFBLE1BQU0sRUFBRSxNQUQwSDtBQUVsSXlDLE1BQUFBLElBQUksRUFBRU4sUUFGNEg7QUFHOUhPLE1BQUFBLE9BQU8sRUFBRSxFQUNULEdBQUdMO0FBRE07QUFIcUgsS0FBakcsQ0FBckM7QUFRQSxRQUFJTSxTQUFTLEdBQUcsTUFBTUosaUJBQWlCLENBQUM1RCxJQUFsQixFQUF0Qjs7QUFFQSxRQUFJcUQsQ0FBQyxJQUFJLENBQVQsRUFBWTtBQUNSRCxNQUFBQSxRQUFRLEdBQUdZLFNBQVg7QUFDSCxLQUZELE1BRU87QUFDSFosTUFBQUEsUUFBUSxHQUFHWCxNQUFNLENBQUNDLElBQVAsQ0FBWXNCLFNBQVMsQ0FBQ0MsU0FBVixDQUFvQkMsT0FBcEIsQ0FBNEIsd0JBQTVCLEVBQXNELEVBQXRELENBQVosRUFBdUUsUUFBdkUsQ0FBWDtBQUNIOztBQUVEN0UsSUFBQUEsTUFBTSxDQUFDa0QsSUFBUCxDQUFhLHVDQUFzQ2MsQ0FBRSxHQUFyRDtBQUNIOztBQUVELFNBQU9ELFFBQVA7QUFDSDs7QUFFRCxlQUFlSyxVQUFmLENBQTBCUCxJQUExQixFQUFnQ2YsR0FBaEMsRUFBcUM7QUFDakMsTUFBSXFCLFFBQVEsR0FBRyxJQUFJVyxTQUFKLEVBQWY7QUFDQVgsRUFBQUEsUUFBUSxDQUFDWSxNQUFULENBQWdCLE1BQWhCLEVBQXdCbEIsSUFBeEIsRUFBOEI7QUFBQ21CLElBQUFBLFFBQVEsRUFBRSxNQUFYO0FBQW1CL0MsSUFBQUEsSUFBSSxFQUFFNEI7QUFBekIsR0FBOUI7QUFDQU0sRUFBQUEsUUFBUSxDQUFDWSxNQUFULENBQWdCLE1BQWhCLEVBQXdCakMsR0FBeEIsRUFBNkI7QUFBQ2tDLElBQUFBLFFBQVEsRUFBRSxLQUFYO0FBQWtCL0MsSUFBQUEsSUFBSSxFQUFFYTtBQUF4QixHQUE3QjtBQUNBOUMsRUFBQUEsTUFBTSxDQUFDa0QsSUFBUCxDQUFZLHVCQUFaO0FBRUEsU0FBT2lCLFFBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZXdyZWxpYyBmcm9tICduZXdyZWxpYyc7XG5pbXBvcnQgeyBjb25uZWN0IH0gZnJvbSAnaHR0cDInO1xuaW1wb3J0IG15c3FsIGZyb20gJ215c3FsMidcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJ1xuaW1wb3J0IEZvcm1EYXRhIGZyb20gJ2Zvcm0tZGF0YSdcbmltcG9ydCB3aW5zdG9uIGZyb20gJ3dpbnN0b24nXG5pbXBvcnQgbmV3cmVsaWNGb3JtYXR0ZXIgZnJvbSAnQG5ld3JlbGljL3dpbnN0b24tZW5yaWNoZXInXG5cbmNvbnN0IGxvZ2dlciA9IHdpbnN0b24uY3JlYXRlTG9nZ2VyKHtcbiAgICBsZXZlbDogJ2luZm8nLFxuICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSgpXG4gICAgXSxcbiAgICBmb3JtYXQ6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUoXG4gICAgICAgIHdpbnN0b24uZm9ybWF0LmxhYmVsKHsgbW9kdWxlOiAnaGVscGVycy5qcycgfSksXG4gICAgICAgIG5ld3JlbGljRm9ybWF0dGVyKCksXG4gICAgICAgIHdpbnN0b24uZm9ybWF0Lmpzb24oKVxuICAgIClcbiAgfSk7XG5jb25zdCBIT1NUID0gcHJvY2Vzcy5lbnYuSE9TVDtcbmNvbnN0IFBBU1NXT1JEID0gcHJvY2Vzcy5lbnYuUEFTU1dPUkQ7XG5cbmNvbnN0IGNvbiA9IG15c3FsLmNyZWF0ZUNvbm5lY3Rpb24oe1xuICAgIGhvc3Q6IEhPU1QsXG4gICAgcG9ydDogJzMzMDYnLFxuICAgIHVzZXI6IFwiYWRtaW5cIixcbiAgICBwYXNzd29yZDogUEFTU1dPUkQsXG59KTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxpc3RQaWN0dXJlcygpIHtcbiAgICB2YXIgc3FsID0gXCJTRUxFQ1QgKiBGUk9NIG1haW4uaW1hZ2VzIFdIRVJFIGFwcHJvdmU9J3RydWUnXCI7XG4gICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IGNvbi5wcm9taXNlKCkucXVlcnkoc3FsKVxuICAgIHJldHVybiByZXN1bHRzXG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRCdWZmZXIodXJsKSB7XG4gICAgbGV0IHJlc3AgPSBhd2FpdCBmZXRjaCh1cmwse1xuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgIH0pXG5cbiAgICAvLyByZWNlaXZlIHRoZSByZXNwb25zZVxuICAgIGxldCBkYXRhID0gYXdhaXQgcmVzcC5hcnJheUJ1ZmZlcigpXG4gICAgcmV0dXJuIGRhdGFcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNwZWNpZmljSGF0KHN0eWxlKSB7XG4gICAgdmFyIHNxbCA9IGBTRUxFQ1QgKiBGUk9NIG1haW4uaW1hZ2VzIFdIRVJFIEJJTkFSWSBkZXNjcmlwdGlvbj0nJHtzdHlsZX0nIEFORCBhcHByb3ZlPSd0cnVlJ2A7XG4gICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IGNvbi5wcm9taXNlKCkucXVlcnkoc3FsKVxuICAgICAgICAuY2F0Y2goZXJyID0+IGxvZ2dlci5lcnJvcihlcnIpKVxuICAgIC8vbG9nZ2VyLmluZm8oYGdldFNwZWNpZmljSGF0IHJlc3VsdHM6ICR7SlNPTi5zdHJpbmdpZnkocmVzdWx0cyl9YCk7XG4gICAgbGV0IGhhdExpc3QgPSByZXN1bHRzWzBdXG4gICAgLy9sb2dnZXIuaW5mbyhgaGF0TGlzdDogJHtKU09OLnN0cmluZ2lmeShoYXRMaXN0KX1gKVxuICAgIGlmIChoYXRMaXN0Lmxlbmd0aCA9PSAwKXtcbiAgICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICBsZXQgcmFuZE51bSA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGhhdExpc3QubGVuZ3RoKVxuICAgIGxldCBoYXQgPSBoYXRMaXN0W3JhbmROdW1dO1xuICAgIGxldCBoYXRMaW5rID0gaGF0LnVybFxuICAgIG5ld3JlbGljLmFkZEN1c3RvbUF0dHJpYnV0ZSgnc3R5bGUnLCAnZ29vcCcpO1xuICAgIGxvZ2dlci5pbmZvKGBoYXRMaW5rOiAke2hhdExpbmt9YClcblxuICAgIGxldCBpbWFnZSA9IGF3YWl0IGRvd25sb2FkQnVmZmVyKGhhdExpbmspXG4gICAgaW1hZ2UgPSBCdWZmZXIuZnJvbShpbWFnZSlcblxuICAgIHJldHVybiBpbWFnZVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0SGF0RGF0YSgpIHtcbiAgICB2YXIgc3FsID0gYFNFTEVDVCBkZXNjcmlwdGlvbiwgdXJsIEZST00gbWFpbi5pbWFnZXMgV0hFUkUgYXBwcm92ZT0ndHJ1ZSdgO1xuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBjb24ucHJvbWlzZSgpLnF1ZXJ5KHNxbClcbiAgICAvL2xvZ2dlci5pbmZvKGBnZXRoYXRkYXRhIHJlc3VsdHM6ICR7cmVzdWx0c31gKTtcbiAgICBsZXQgaGF0TGlzdCA9IHJlc3VsdHNbMF1cbiAgICAvL2xvZ2dlci5pbmZvKGhhdExpc3QpXG5cbiAgICByZXR1cm4gaGF0TGlzdFxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UmFuZG9tSGF0KCkge1xuICAgIC8vIGdldCByYW5kb20gaGF0IHBpY3R1cmVcbiAgICBsZXQgaGF0cyA9IGF3YWl0IGxpc3RQaWN0dXJlcygpXG4gICAgbGV0IGhhdExpc3QgPSBoYXRzWzBdXG4gICAgLy9sb2dnZXIuaW5mbyhgZ2V0UmFuZG9tSGF0IGhhdGxpc3RMICR7aGF0TGlzdH1gKTtcblxuICAgIGxldCByYW5kTnVtID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogaGF0TGlzdC5sZW5ndGgpXG4gICAgbGV0IGhhdCA9IGhhdExpc3RbcmFuZE51bV07XG4gICAgbGV0IGhhdExpbmsgPSBoYXQudXJsO1xuICAgIG5ld3JlbGljLmFkZEN1c3RvbUF0dHJpYnV0ZSgnc3R5bGUnLCBoYXQuZGVzY3JpcHRpb24pO1xuICAgIGxvZ2dlci5pbmZvKGBnZXRSYW5kb21IYXQgaGF0TGluayAke2hhdExpbmt9YCk7XG5cbiAgICBsZXQgaW1hZ2UgPSBhd2FpdCBkb3dubG9hZEJ1ZmZlcihoYXRMaW5rKVxuICAgIGltYWdlID0gQnVmZmVyLmZyb20oaW1hZ2UpXG4gICAgcmV0dXJuIGltYWdlXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWZhdWx0Qm9zcygpIHtcbiAgICAvL215IGZhdiBib3NzIGV2ZXJcbiAgICBsZXQgam9obktpbm1vbnRoID0gYXdhaXQgZG93bmxvYWRCdWZmZXIoXCJodHRwczovL3VzZXItaW1hZ2VzLmdpdGh1YnVzZXJjb250ZW50LmNvbS82OTMzMjk2NC8xMjg2NDUxNDMtODY0MDVhNjItNjkxYi00ZGU5LTg1MDAtYjkzNjI2NzVlMWRiLnBuZ1wiKTtcbiAgICBqb2huS2lubW9udGggPSBCdWZmZXIuZnJvbShqb2huS2lubW9udGgpXG5cbiAgICByZXR1cm4gam9obktpbm1vbnRoXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXF1ZXN0TWFuaXB1bGF0ZShmYWNlLCBoYXQsIG51bWJlckhhdHMpIHtcbiAgICAvLyBoaXQgdGhlIHVwbG9hZCBlbmRwb2ludCB0byB1cGxvYWQgaW1hZ2UgYW5kIHJldHJpZXZlIHVuaXF1ZSBpbWFnZSBpZFxuICAgIGxldCBmYWNlRGF0YSA9IGZhY2VcbiAgICBsb2dnZXIuaW5mbyhcIlN0YXJ0IGxvb3BcIilcbiAgICBsb2dnZXIuaW5mbyhudW1iZXJIYXRzKVxuICAgIGZvciAodmFyIGkgPSBudW1iZXJIYXRzOyBpID49IDE7IGktLSkge1xuICAgICAgICBsb2dnZXIuaW5mbyhpKVxuICAgICAgICBsZXQgdHJhbnNsYXRlID0gaSowLjZcbiAgICAgICAgbGV0IHJvdGF0ZSA9IGkqMTBcbiAgICAgICAgbGV0IGZvcm1EYXRhID0gYXdhaXQgY3JlYXRlRm9ybShmYWNlRGF0YSwgaGF0KVxuICAgICAgICBjb25zdCBmb3JtSGVhZGVycyA9IGZvcm1EYXRhLmdldEhlYWRlcnMoKTtcbiAgICAgICAgY29uc3QgbWFuaXB1bGF0ZVJlcXVlc3QgPSBhd2FpdCBmZXRjaChgaHR0cDovLyR7cHJvY2Vzcy5lbnYuTUFOSVBVTEFURV9FTkRQT0lOVH0vbWFuaXB1bGF0ZT90cmFuc2xhdGU9JHt0cmFuc2xhdGV9JnJvdGF0ZT0ke3JvdGF0ZX1gLCB7XG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGJvZHk6IGZvcm1EYXRhLFxuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAuLi5mb3JtSGVhZGVycyxcbiAgICAgICAgICAgICAgICB9LCAgICAgICAgXG4gICAgICAgIH0pO1xuICAgIFxuICAgICAgICB2YXIgYjY0UmVzdWx0ID0gYXdhaXQgbWFuaXB1bGF0ZVJlcXVlc3QuanNvbigpXG5cbiAgICAgICAgaWYgKGkgPT0gMSkge1xuICAgICAgICAgICAgZmFjZURhdGEgPSBiNjRSZXN1bHRcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZhY2VEYXRhID0gQnVmZmVyLmZyb20oYjY0UmVzdWx0LmZpbmFsQmFieS5yZXBsYWNlKFwiZGF0YTppbWFnZS9wbmc7YmFzZTY0LFwiLCBcIlwiKSwgXCJiYXNlNjRcIik7XG4gICAgICAgIH1cblxuICAgICAgICBsb2dnZXIuaW5mbyhgUmVjZWl2ZWQgcmVzcG9uc2UgZnJvbSAvbWFuaXB1bGF0ZSBbJHtpfV1gKVxuICAgIH1cblxuICAgIHJldHVybiBmYWNlRGF0YVxufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVGb3JtKGZhY2UsIGhhdCkge1xuICAgIGxldCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpXG4gICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgZmFjZSwge2ZpbGVuYW1lOiBcImZhY2VcIiwgZGF0YTogZmFjZX0pXG4gICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgaGF0LCB7ZmlsZW5hbWU6IFwiaGF0XCIsIGRhdGE6IGhhdH0pXG4gICAgbG9nZ2VyLmluZm8oXCJQb3N0aW5nIHRvIE1hbmlwdWxhdGVcIilcblxuICAgIHJldHVybiBmb3JtRGF0YVxufSJdfQ==