"use strict";

require('newrelic');

var express = require('express');

var app = express();
var router = express.Router();

var multer = require('multer');

const upload = multer();

var fetch = require('node-fetch');

var dirname = require('path').dirname;

var url = require('url');

var fileURLToPath = url.fileURLToPath;

var FormData = require('form-data'); // express is what helps us "route" the html pages. Usually on websites, you don't see /index.html. 
// Why? Because they use routing! When you navigate to /about, the web server with THIS code returns the HTML about.html page.


const dn = dirname(__filename);
app.set('view engine', 'ejs');
app.set('views', dn); // this is just setting up configuration for where all the files are.

const path = dn; //__dirname is the current directory we are in. Remember that every website literally has a computer running behind it!

app.use('/', router);
app.use('/assets', express.static(path + '/assets')); // this is telling the website WHERE all of our "asset" files are. Asset files include CSS for styling, JS for Bootstrap to make it pretty, and images.

router.get('/', function (req, res) {
  res.sendFile(path + '/pages/index.html');
}); // The logic here: when someone navigates to www.cybercatamounts.herokuapp.com, the website will return the content on the "index.html" page.
// Why is it router.get? Because when you enter something in your browser, you are making a GET request.

router.get('/photo', function (req, res) {
  res.sendFile(path + '/pages/photo.html');
});
router.get('/admin', function (req, res) {
  res.sendFile(path + '/pages/admin.html');
});
router.get('/api/hat', upload.any(), async function (req, res) {
  let baseUrl = new url.URL("http://gateway-service:80/hatme");
  const number = req.query.number ? req.query.number : "1"; //console.log(req.body);

  let type = req.headers.type; //console.log(type);

  if (type) {
    baseUrl.searchParams.append('style', type);
  }

  baseUrl.searchParams.append('number', number); //console.log(baseUrl);

  let resp = await fetch(baseUrl.toString());
  let data = await resp.json(); //console.log(data);

  res.send(data);
});
router.post('/api/hat', upload.any(), async function (req, res) {
  console.log("posting custom photo");
  let baseUrl = new url.URL("http://gateway-service:80/hatme");
  const number = req.query.number ? req.query.number : "1";
  let file = req.files[0].buffer;
  let formData = await createForm(file);
  const formHeaders = await formData.getHeaders();
  let type = req.headers.type; //console.log(file);

  let options = {
    method: "POST",
    body: formData,
    headers: { ...formHeaders
    }
  };

  if (type) {
    baseUrl.searchParams.append('style', type);
  }

  baseUrl.searchParams.append('number', number);
  console.log(`posting to ${baseUrl}`);
  let resp = await fetch(baseUrl, options);
  let data = await resp.json(); //console.log(data);

  res.send(data);
});

async function createForm(file) {
  let formData = new FormData();
  formData.append('file', file, {
    filename: "file",
    data: file
  });
  console.log("Posting to Manipulate");
  return formData;
}

router.get('/api/list', async function (req, res) {
  const baseUrl = "http://gateway-service:80/api/hats";
  const resp = await fetch(baseUrl);
  const data = await resp.json();
  console.log(data);
  res.send(data);
});
router.get('/api/admin', async function (req, res) {
  let baseUrl = "http://gateway-service:80/admin";
  let resp = await fetch(baseUrl);
  let data = await resp.json();
  res.send(data);
});
router.get('/api/admin/moderate', async function (req, res) {
  let id = req.query.id;
  let approve = req.query.approve;
  let baseUrl = `http://gateway-service:80/moderate?id=${id}&approve=${approve}`;
  let resp = await fetch(baseUrl);
  let data = await resp.json();
  console.log(data);
  res.send(data);
});
app.listen(process.env.PORT || 3000, () => console.log("Server is running..."));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbInJlcXVpcmUiLCJleHByZXNzIiwiYXBwIiwicm91dGVyIiwiUm91dGVyIiwibXVsdGVyIiwidXBsb2FkIiwiZmV0Y2giLCJkaXJuYW1lIiwidXJsIiwiZmlsZVVSTFRvUGF0aCIsIkZvcm1EYXRhIiwiZG4iLCJfX2ZpbGVuYW1lIiwic2V0IiwicGF0aCIsInVzZSIsInN0YXRpYyIsImdldCIsInJlcSIsInJlcyIsInNlbmRGaWxlIiwiYW55IiwiYmFzZVVybCIsIlVSTCIsIm51bWJlciIsInF1ZXJ5IiwidHlwZSIsImhlYWRlcnMiLCJzZWFyY2hQYXJhbXMiLCJhcHBlbmQiLCJyZXNwIiwidG9TdHJpbmciLCJkYXRhIiwianNvbiIsInNlbmQiLCJwb3N0IiwiY29uc29sZSIsImxvZyIsImZpbGUiLCJmaWxlcyIsImJ1ZmZlciIsImZvcm1EYXRhIiwiY3JlYXRlRm9ybSIsImZvcm1IZWFkZXJzIiwiZ2V0SGVhZGVycyIsIm9wdGlvbnMiLCJtZXRob2QiLCJib2R5IiwiZmlsZW5hbWUiLCJpZCIsImFwcHJvdmUiLCJsaXN0ZW4iLCJwcm9jZXNzIiwiZW52IiwiUE9SVCJdLCJtYXBwaW5ncyI6Ijs7QUFBQUEsT0FBTyxDQUFDLFVBQUQsQ0FBUDs7QUFDQSxJQUFJQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxTQUFELENBQXJCOztBQUNBLElBQUlFLEdBQUcsR0FBR0QsT0FBTyxFQUFqQjtBQUNBLElBQUlFLE1BQU0sR0FBR0YsT0FBTyxDQUFDRyxNQUFSLEVBQWI7O0FBQ0EsSUFBSUMsTUFBTSxHQUFHTCxPQUFPLENBQUMsUUFBRCxDQUFwQjs7QUFDQSxNQUFNTSxNQUFNLEdBQUdELE1BQU0sRUFBckI7O0FBQ0EsSUFBSUUsS0FBSyxHQUFHUCxPQUFPLENBQUMsWUFBRCxDQUFuQjs7QUFDQSxJQUFJUSxPQUFPLEdBQUdSLE9BQU8sQ0FBQyxNQUFELENBQVAsQ0FBZ0JRLE9BQTlCOztBQUNBLElBQUlDLEdBQUcsR0FBR1Qs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R0FBRyxNQUFNeEIsS0FBSyxDQUFDZ0IsT0FBRCxDQUF0QjtBQUNBLE1BQUlVLElBQUksR0FBRyxNQUFNRixJQUFJLENBQUNHLElBQUwsRUFBakI7QUFDQUcsRUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlMLElBQVo7QUFDQWIsRUFBQUEsR0FBRyxDQUFDZSxJQUFKLENBQVNGLElBQVQ7QUFFSCxDQVhEO0FBYUEvQixHQUFHLENBQUNrRCxNQUFKLENBQVdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxJQUFaLElBQW9CLElBQS9CLEVBQ0ksTUFBTWxCLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLHNCQUFaLENBRFYiLCJzb3VyY2VzQ29udGVudCI6WyJyZXF1aXJlKCduZXdyZWxpYycpXG52YXIgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbnZhciBhcHAgPSBleHByZXNzKCk7XG52YXIgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbnZhciBtdWx0ZXIgPSByZXF1aXJlKCdtdWx0ZXInKTtcbmNvbnN0IHVwbG9hZCA9IG11bHRlcigpO1xudmFyIGZldGNoID0gcmVxdWlyZSgnbm9kZS1mZXRjaCcpO1xudmFyIGRpcm5hbWUgPSByZXF1aXJlKCdwYXRoJykuZGlybmFtZTtcbnZhciB1cmwgPSByZXF1aXJlKCd1cmwnKTtcbnZhciBmaWxlVVJMVG9QYXRoID0gdXJsLmZpbGVVUkxUb1BhdGg7XG52YXIgRm9ybURhdGEgPSByZXF1aXJlKCdmb3JtLWRhdGEnKVxuXG4vLyBleHByZXNzIGlzIHdoYXQgaGVscHMgdXMgXCJyb3V0ZVwiIHRoZSBodG1sIHBhZ2VzLiBVc3VhbGx5IG9uIHdlYnNpdGVzLCB5b3UgZG9uJ3Qgc2VlIC9pbmRleC5odG1sLiBcbi8vIFdoeT8gQmVjYXVzZSB0aGV5IHVzZSByb3V0aW5nISBXaGVuIHlvdSBuYXZpZ2F0ZSB0byAvYWJvdXQsIHRoZSB3ZWIgc2VydmVyIHdpdGggVEhJUyBjb2RlIHJldHVybnMgdGhlIEhUTUwgYWJvdXQuaHRtbCBwYWdlLlxuXG5jb25zdCBkbiA9IGRpcm5hbWUoX19maWxlbmFtZSk7XG5hcHAuc2V0KCd2aWV3IGVuZ2luZScsICdlanMnKTtcbmFwcC5zZXQoJ3ZpZXdzJywgZG4pO1xuXG4vLyB0aGlzIGlzIGp1c3Qgc2V0dGluZyB1cCBjb25maWd1cmF0aW9uIGZvciB3aGVyZSBhbGwgdGhlIGZpbGVzIGFyZS5cbmNvbnN0IHBhdGggPSBkbjtcblxuLy9fX2Rpcm5hbWUgaXMgdGhlIGN1cnJlbnQgZGlyZWN0b3J5IHdlIGFyZSBpbi4gUmVtZW1iZXIgdGhhdCBldmVyeSB3ZWJzaXRlIGxpdGVyYWxseSBoYXMgYSBjb21wdXRlciBydW5uaW5nIGJlaGluZCBpdCFcbmFwcC51c2UoJy8nLCByb3V0ZXIpO1xuYXBwLnVzZSgnL2Fzc2V0cycsIGV4cHJlc3Muc3RhdGljKHBhdGggKyAnL2Fzc2V0cycpKVxuXG4vLyB0aGlzIGlzIHRlbGxpbmcgdGhlIHdlYnNpdGUgV0hFUkUgYWxsIG9mIG91ciBcImFzc2V0XCIgZmlsZXMgYXJlLiBBc3NldCBmaWxlcyBpbmNsdWRlIENTUyBmb3Igc3R5bGluZywgSlMgZm9yIEJvb3RzdHJhcCB0byBtYWtlIGl0IHByZXR0eSwgYW5kIGltYWdlcy5cblxucm91dGVyLmdldCgnLycsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIHJlcy5zZW5kRmlsZShwYXRoICsgJy9wYWdlcy9pbmRleC5odG1sJyk7XG59KTtcblxuLy8gVGhlIGxvZ2ljIGhlcmU6IHdoZW4gc29tZW9uZSBuYXZpZ2F0ZXMgdG8gd3d3LmN5YmVyY2F0YW1vdW50cy5oZXJva3VhcHAuY29tLCB0aGUgd2Vic2l0ZSB3aWxsIHJldHVybiB0aGUgY29udGVudCBvbiB0aGUgXCJpbmRleC5odG1sXCIgcGFnZS5cbi8vIFdoeSBpcyBpdCByb3V0ZXIuZ2V0PyBCZWNhdXNlIHdoZW4geW91IGVudGVyIHNvbWV0aGluZyBpbiB5b3VyIGJyb3dzZXIsIHlvdSBhcmUgbWFraW5nIGEgR0VUIHJlcXVlc3QuXG5cbnJvdXRlci5nZXQoJy9waG90bycsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIHJlcy5zZW5kRmlsZShwYXRoICsgJy9wYWdlcy9waG90by5odG1sJyk7XG59KTtcblxucm91dGVyLmdldCgnL2FkbWluJywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgcmVzLnNlbmRGaWxlKHBhdGggKyAnL3BhZ2VzL2FkbWluLmh0bWwnKTtcbn0pO1xuXG5yb3V0ZXIuZ2V0KCcvYXBpL2hhdCcsIHVwbG9hZC5hbnkoKSwgYXN5bmMgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgbGV0IGJhc2VVcmwgPSBuZXcgdXJsLlVSTChcImh0dHA6Ly9nYXRld2F5LXNlcnZpY2U6ODAvaGF0bWVcIik7XG4gICAgY29uc3QgbnVtYmVyID0gcmVxLnF1ZXJ5Lm51bWJlciA/IHJlcS5xdWVyeS5udW1iZXIgOiBcIjFcIjtcbiAgICAvL2NvbnNvbGUubG9nKHJlcS5ib2R5KTtcbiAgICBsZXQgdHlwZSA9IHJlcS5oZWFkZXJzLnR5cGU7XG4gICAgLy9jb25zb2xlLmxvZyh0eXBlKTtcblxuICAgIGlmICh0eXBlKSB7XG4gICAgICAgIGJhc2VVcmwuc2VhcmNoUGFyYW1zLmFwcGVuZCgnc3R5bGUnLCB0eXBlKTtcbiAgICB9XG5cbiAgICBiYXNlVXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoJ251bWJlcicsIG51bWJlcik7XG5cblxuICAgIC8vY29uc29sZS5sb2coYmFzZVVybCk7XG4gICAgbGV0IHJlc3AgPSBhd2FpdCBmZXRjaChiYXNlVXJsLnRvU3RyaW5nKCkpO1xuICAgIGxldCBkYXRhID0gYXdhaXQgcmVzcC5qc29uKCk7XG4gICAgLy9jb25zb2xlLmxvZyhkYXRhKTtcbiAgICByZXMuc2VuZChkYXRhKTtcbn0pO1xuXG5yb3V0ZXIucG9zdCgnL2FwaS9oYXQnLCB1cGxvYWQuYW55KCksIGFzeW5jIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIGNvbnNvbGUubG9nKFwicG9zdGluZyBjdXN0b20gcGhvdG9cIik7XG4gICAgbGV0IGJhc2VVcmwgPSBuZXcgdXJsLlVSTChcImh0dHA6Ly9nYXRld2F5LXNlcnZpY2U6ODAvaGF0bWVcIik7XG4gICAgY29uc3QgbnVtYmVyID0gcmVxLnF1ZXJ5Lm51bWJlciA/IHJlcS5xdWVyeS5udW1iZXIgOiBcIjFcIjtcblxuICAgIGxldCBmaWxlID0gcmVxLmZpbGVzWzBdLmJ1ZmZlcjtcblxuICAgIGxldCBmb3JtRGF0YSA9IGF3YWl0IGNyZWF0ZUZvcm0oZmlsZSk7XG4gICAgY29uc3QgZm9ybUhlYWRlcnMgPSBhd2FpdCBmb3JtRGF0YS5nZXRIZWFkZXJzKCk7XG4gICAgbGV0IHR5cGUgPSByZXEuaGVhZGVycy50eXBlO1xuICAgIC8vY29uc29sZS5sb2coZmlsZSk7XG4gICAgbGV0IG9wdGlvbnMgPSB7XG4gICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICAgIGJvZHk6IGZvcm1EYXRhLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAuLi5mb3JtSGVhZGVycyxcbiAgICAgICAgfSxcbiAgICB9O1xuXG4gICAgaWYgKHR5cGUpIHtcbiAgICAgICAgYmFzZVVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKCdzdHlsZScsIHR5cGUpO1xuICAgIH1cblxuICAgIGJhc2VVcmwuc2VhcmNoUGFyYW1zLmFwcGVuZCgnbnVtYmVyJywgbnVtYmVyKTtcbiAgICBjb25zb2xlLmxvZyhgcG9zdGluZyB0byAke2Jhc2VVcmx9YCk7XG4gICAgbGV0IHJlc3AgPSBhd2FpdCBmZXRjaChiYXNlVXJsLCBvcHRpb25zKTtcbiAgICBsZXQgZGF0YSA9IGF3YWl0IHJlc3AuanNvbigpO1xuICAgIC8vY29uc29sZS5sb2coZGF0YSk7XG4gICAgcmVzLnNlbmQoZGF0YSk7XG5cbn0pO1xuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVGb3JtKGZpbGUpIHtcbiAgICBsZXQgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKVxuICAgIGZvcm1EYXRhLmFwcGVuZCgnZmlsZScsIGZpbGUsIHsgZmlsZW5hbWU6IFwiZmlsZVwiLCBkYXRhOiBmaWxlIH0pXG4gICAgY29uc29sZS5sb2coXCJQb3N0aW5nIHRvIE1hbmlwdWxhdGVcIilcblxuICAgIHJldHVybiBmb3JtRGF0YVxufVxuXG5yb3V0ZXIuZ2V0KCcvYXBpL2xpc3QnLCBhc3luYyBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICBjb25zdCBiYXNlVXJsID0gXCJodHRwOi8vZ2F0ZXdheS1zZXJ2aWNlOjgwL2FwaS9oYXRzXCI7XG5cbiAgICBjb25zdCByZXNwID0gYXdhaXQgZmV0Y2goYmFzZVVybCk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3AuanNvbigpO1xuICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgIHJlcy5zZW5kKGRhdGEpO1xufSk7XG5cblxucm91dGVyLmdldCgnL2FwaS9hZG1pbicsIGFzeW5jIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIGxldCBiYXNlVXJsID0gXCJodHRwOi8vZ2F0ZXdheS1zZXJ2aWNlOjgwL2FkbWluXCJcbiAgICBsZXQgcmVzcCA9IGF3YWl0IGZldGNoKGJhc2VVcmwpO1xuICAgIGxldCBkYXRhID0gYXdhaXQgcmVzcC5qc29uKCk7XG4gICAgcmVzLnNlbmQoZGF0YSk7XG59KTtcblxucm91dGVyLmdldCgnL2FwaS9hZG1pbi9tb2RlcmF0ZScsIGFzeW5jIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIGxldCBpZCA9IHJlcS5xdWVyeS5pZDtcbiAgICBsZXQgYXBwcm92ZSA9IHJlcS5xdWVyeS5hcHByb3ZlO1xuXG4gICAgbGV0IGJhc2VVcmwgPSBgaHR0cDovL2dhdGV3YXktc2VydmljZTo4MC9tb2RlcmF0ZT9pZD0ke2lkfSZhcHByb3ZlPSR7YXBwcm92ZX1gO1xuXG4gICAgbGV0IHJlc3AgPSBhd2FpdCBmZXRjaChiYXNlVXJsKTtcbiAgICBsZXQgZGF0YSA9IGF3YWl0IHJlc3AuanNvbigpO1xuICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgIHJlcy5zZW5kKGRhdGEpO1xuXG59KTtcblxuYXBwLmxpc3Rlbihwcm9jZXNzLmVudi5QT1JUIHx8IDMwMDAsXG4gICAgKCkgPT4gY29uc29sZS5sb2coXCJTZXJ2ZXIgaXMgcnVubmluZy4uLlwiKSk7Il19