"use strict";

require('newrelic');

var express = require('express');

require('express-async-errors');

var app = express();
var router = express.Router();

var multer = require('multer');

const upload = multer();

var fetch = require('node-fetch');

var dirname = require('path').dirname;

var url = require('url');

var fileURLToPath = url.fileURLToPath;

var FormData = require('form-data');

const winston = require('winston');

const newrelicFormatter = require('@newrelic/winston-enricher');

const logger = winston.createLogger({
  level: 'info',
  exitOnError: false,
  transports: [new winston.transports.Console({
    handleExceptions: true,
    handleRejections: true
  })],
  format: winston.format.combine(winston.format((info, opts) => Object.assign(info, {
    module: __filename
  }))(), newrelicFormatter(), winston.format.json())
}); // express is what helps us "route" the html pages. Usually on websites, you don't see /index.html. 
// Why? Because they use routing! When you navigate to /about, the web server with THIS code returns the HTML about.html page.

const dn = dirname(__filename);
app.set('view engine', 'ejs');
app.set('views', dn); // this is just setting up configuration for where all the files are.

const path = dn; //__dirname is the current directory we are in. Remember that every website literally has a computer running behind it!

app.use('/', router);
app.use('/assets', express.static(path + '/assets')); // this is telling the website WHERE all of our "asset" files are. Asset files include CSS for styling, JS for Bootstrap to make it pretty, and images.

router.get('/', function (req, res) {
  res.sendFile(path + '/pages/index.html');
}); // The logic here: when someone navigates to www.cybercatamounts.herokuapp.com, the website will return the content on the "index.html" page.
// Why is it router.get? Because when you enter something in your browser, you are making a GET request.

router.get('/photo', function photo(req, res) {
  res.sendFile(path + '/pages/photo.html');
});
router.get('/admin', function admin(req, res) {
  res.sendFile(path + '/pages/admin.html');
});
router.get('/api/hat', upload.any(), async function hatGet(req, res) {
  let baseUrl = new url.URL("http://gateway-service:80/hatme");
  const number = req.query.number ? req.query.number : "1"; //logger.info(req.body);

  let type = req.headers.type; //logger.info(type);

  if (type) {
    baseUrl.searchParams.append('style', type);
  }

  baseUrl.searchParams.append('number', number);
  logger.info(`GET ${baseUrl}`);
  let resp = await fetch(baseUrl.toString());
  let data = await resp.json(); //logger.info(data);

  res.send(data);
});
router.post('/api/hat', upload.any(), async function hatPost(req, res) {
  logger.info("posting custom photo");
  let baseUrl = new url.URL("http://gateway-service:80/hatme");
  const number = req.query.number ? req.query.number : "1";
  let file = req.files[0].buffer;
  let formData = await createForm(file);
  const formHeaders = await formData.getHeaders();
  let type = req.headers.type; //logger.info(file);

  let options = {
    method: "POST",
    body: formData,
    headers: { ...formHeaders
    }
  };

  if (type) {
    baseUrl.searchParams.append('style', type);
  }

  baseUrl.searchParams.append('number', number);
  logger.info(`POST ${baseUrl}`);
  let resp = await fetch(baseUrl, options);
  let data = await resp.json(); //logger.info(data);

  res.send(data);
});

async function createForm(file) {
  let formData = new FormData();
  formData.append('file', file, {
    filename: "file",
    data: file
  });
  return formData;
}

router.get('/api/list', async function list(req, res) {
  const baseUrl = "http://gateway-service:80/api/hats";
  logger.info(`GET ${baseUrl}`);
  const resp = await fetch(baseUrl);
  const data = await resp.json();
  res.send(data);
});
router.get('/api/admin', async function admin(req, res) {
  let baseUrl = "http://gateway-service:80/admin";
  logger.info(`GET ${baseUrl}`);
  let resp = await fetch(baseUrl);
  let data = await resp.json();
  res.send(data);
});
router.get('/api/admin/moderate', async function moderate(req, res) {
  let id = req.query.id;
  let approve = req.query.approve;
  let baseUrl = `http://gateway-service:80/moderate?id=${id}&approve=${approve}`;
  logger.info(`GET ${baseUrl}`);
  let resp = await fetch(baseUrl);
  let data = await resp.json(); //logger.info(data);

  res.send(data);
});
app.listen(process.env.PORT || 3000, () => logger.info("Server is running..."));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbInJlcXVpcmUiLCJleHByZXNzIiwiYXBwIiwicm91dGVyIiwiUm91dGVyIiwibXVsdGVyIiwidXBsb2FkIiwiZmV0Y2giLCJkaXJuYW1lIiwidXJsIiwiZmlsZVVSTFRvUGF0aCIsIkZvcm1EYXRhIiwid2luc3RvbiIsIm5ld3JlbGljRm9ybWF0dGVyIiwibG9nZ2VyIiwiY3JlYXRlTG9nZ2VyIiwibGV2ZWwiLCJleGl0T25FcnJvciIsInRyYW5zcG9ydHMiLCJDb25zb2xlIiwiaGFuZGxlRXhjZXB0aW9ucyIsImhhbmRsZVJlamVjdGlvbnMiLCJmb3JtYXQiLCJjb21iaW5lIiwiaW5mbyIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJtb2R1bGUiLCJfX2ZpbGVuYW1lIiwianNvbiIsImRuIiwic2V0IiwicGF0aCIsInVzZSIsInN0YXRpYyIsImdldCIsInJlcSIsInJlcyIsInNlbmRGaWxlIiwicGhvdG8iLCJhZG1pbiIsImFueSIsImhhdEdldCIsImJhc2VVcmwiLCJVUkwiLCJudW1iZXIiLCJxdWVyeSIsInR5cGUiLCJoZWFkZXJzIiwic2VhcmNoUGFyYW1zIiwiYXBwZW5kIiwicmVzcCIsInRvU3RyaW5nIiwiZGF0YSIsInNlbmQiLCJwb3N0IiwiaGF0UG9zdCIsImZpbGUiLCJmaWxlcyIsImJ1ZmZlciIsImZvcm1EYXRhIiwiY3JlYXRlRm9ybSIsImZvcm1IZWFkZXJzIiwiZ2V0SGVhZGVycyIsIm9wdGlvbnMiLCJtZXRob2QiLCJib2R5IiwiZmlsZW5hbWUiLCJsaXN0IiwibW9kZXJhdGUiLCJpZCIsImFwcHJvdmUiLCJsaXN0ZW4iLCJwcm9jZXNzIiwiZW52IiwiUE9SVCJdLCJtYXBwaW5ncyI6Ijs7QUFBQUEsT0FBTyxDQUFDLFVBQUQsQ0FBUDs7QUFDQSxJQUFJQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxTQUFELENBQXJCOztBQUNBQSxPQUFPLENBQUMsc0JBQUQsQ0FBUDs7QUFDQSxJQUFJRSxHQUFH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VSxLQUFKLENBQVV3QixFQUFuQjtBQUNBLE1BQUlDLE9BQU8sR0FBR25DLEdBQUcsQ0FBQ1UsS0FBSixDQUFVeUIsT0FBeEI7QUFFQSxNQUFJNUIsT0FBTyxHQUFJLHlDQUF3QzJCLEVBQUcsWUFBV0MsT0FBUSxFQUE3RTtBQUVBMUQsRUFBQUEsTUFBTSxDQUFDVSxJQUFQLENBQWEsT0FBTW9CLE9BQVEsRUFBM0I7QUFDQSxNQUFJUSxJQUFJLEdBQUcsTUFBTTdDLEtBQUssQ0FBQ3FDLE9BQUQsQ0FBdEI7QUFDQSxNQUFJVSxJQUFJLEdBQUcsTUFBTUYsSUFBSSxDQUFDdEIsSUFBTCxFQUFqQixDQVJnRSxDQVNoRTs7QUFDQVEsRUFBQUEsR0FBRyxDQUFDaUIsSUFBSixDQUFTRCxJQUFUO0FBRUgsQ0FaRDtBQWNBcEQsR0FBRyxDQUFDdUUsTUFBSixDQUFXQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsSUFBWixJQUFvQixJQUEvQixFQUNJLE1BQU05RCxNQUFNLENBQUNVLElBQVAsQ0FBWSxzQkFBWixDQURWIiwic291cmNlc0NvbnRlbnQiOlsicmVxdWlyZSgnbmV3cmVsaWMnKVxudmFyIGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5yZXF1aXJlKCdleHByZXNzLWFzeW5jLWVycm9ycycpO1xudmFyIGFwcCA9IGV4cHJlc3MoKTtcbnZhciByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xudmFyIG11bHRlciA9IHJlcXVpcmUoJ211bHRlcicpO1xuY29uc3QgdXBsb2FkID0gbXVsdGVyKCk7XG52YXIgZmV0Y2ggPSByZXF1aXJlKCdub2RlLWZldGNoJyk7XG52YXIgZGlybmFtZSA9IHJlcXVpcmUoJ3BhdGgnKS5kaXJuYW1lO1xudmFyIHVybCA9IHJlcXVpcmUoJ3VybCcpO1xudmFyIGZpbGVVUkxUb1BhdGggPSB1cmwuZmlsZVVSTFRvUGF0aDtcbnZhciBGb3JtRGF0YSA9IHJlcXVpcmUoJ2Zvcm0tZGF0YScpXG5cbmNvbnN0IHdpbnN0b24gPSByZXF1aXJlKCd3aW5zdG9uJyk7XG5jb25zdCBuZXdyZWxpY0Zvcm1hdHRlciA9IHJlcXVpcmUoJ0BuZXdyZWxpYy93aW5zdG9uLWVucmljaGVyJyk7XG5cblxuY29uc3QgbG9nZ2VyID0gd2luc3Rvbi5jcmVhdGVMb2dnZXIoe1xuICAgIGxldmVsOiAnaW5mbycsXG4gICAgZXhpdE9uRXJyb3I6IGZhbHNlLFxuICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSh7XG4gICAgICAgIGhhbmRsZUV4Y2VwdGlvbnM6IHRydWUsXG4gICAgICAgIGhhbmRsZVJlamVjdGlvbnM6IHRydWVcbiAgICAgIH0pXG4gICAgXSxcbiAgICBmb3JtYXQ6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUoXG4gICAgICAgIHdpbnN0b24uZm9ybWF0KChpbmZvLCBvcHRzKSA9PiBPYmplY3QuYXNzaWduKGluZm8sIHttb2R1bGU6IF9fZmlsZW5hbWV9KSkoKSxcbiAgICAgICAgbmV3cmVsaWNGb3JtYXR0ZXIoKSxcbiAgICAgICAgd2luc3Rvbi5mb3JtYXQuanNvbigpXG4gICAgKVxuICB9KTtcblxuLy8gZXhwcmVzcyBpcyB3aGF0IGhlbHBzIHVzIFwicm91dGVcIiB0aGUgaHRtbCBwYWdlcy4gVXN1YWxseSBvbiB3ZWJzaXRlcywgeW91IGRvbid0IHNlZSAvaW5kZXguaHRtbC4gXG4vLyBXaHk/IEJlY2F1c2UgdGhleSB1c2Ugcm91dGluZyEgV2hlbiB5b3UgbmF2aWdhdGUgdG8gL2Fib3V0LCB0aGUgd2ViIHNlcnZlciB3aXRoIFRISVMgY29kZSByZXR1cm5zIHRoZSBIVE1MIGFib3V0Lmh0bWwgcGFnZS5cblxuY29uc3QgZG4gPSBkaXJuYW1lKF9fZmlsZW5hbWUpO1xuYXBwLnNldCgndmlldyBlbmdpbmUnLCAnZWpzJyk7XG5hcHAuc2V0KCd2aWV3cycsIGRuKTtcblxuLy8gdGhpcyBpcyBqdXN0IHNldHRpbmcgdXAgY29uZmlndXJhdGlvbiBmb3Igd2hlcmUgYWxsIHRoZSBmaWxlcyBhcmUuXG5jb25zdCBwYXRoID0gZG47XG5cbi8vX19kaXJuYW1lIGlzIHRoZSBjdXJyZW50IGRpcmVjdG9yeSB3ZSBhcmUgaW4uIFJlbWVtYmVyIHRoYXQgZXZlcnkgd2Vic2l0ZSBsaXRlcmFsbHkgaGFzIGEgY29tcHV0ZXIgcnVubmluZyBiZWhpbmQgaXQhXG5hcHAudXNlKCcvJywgcm91dGVyKTtcbmFwcC51c2UoJy9hc3NldHMnLCBleHByZXNzLnN0YXRpYyhwYXRoICsgJy9hc3NldHMnKSlcblxuLy8gdGhpcyBpcyB0ZWxsaW5nIHRoZSB3ZWJzaXRlIFdIRVJFIGFsbCBvZiBvdXIgXCJhc3NldFwiIGZpbGVzIGFyZS4gQXNzZXQgZmlsZXMgaW5jbHVkZSBDU1MgZm9yIHN0eWxpbmcsIEpTIGZvciBCb290c3RyYXAgdG8gbWFrZSBpdCBwcmV0dHksIGFuZCBpbWFnZXMuXG5cbnJvdXRlci5nZXQoJy8nLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICByZXMuc2VuZEZpbGUocGF0aCArICcvcGFnZXMvaW5kZXguaHRtbCcpO1xufSk7XG5cbi8vIFRoZSBsb2dpYyBoZXJlOiB3aGVuIHNvbWVvbmUgbmF2aWdhdGVzIHRvIHd3dy5jeWJlcmNhdGFtb3VudHMuaGVyb2t1YXBwLmNvbSwgdGhlIHdlYnNpdGUgd2lsbCByZXR1cm4gdGhlIGNvbnRlbnQgb24gdGhlIFwiaW5kZXguaHRtbFwiIHBhZ2UuXG4vLyBXaHkgaXMgaXQgcm91dGVyLmdldD8gQmVjYXVzZSB3aGVuIHlvdSBlbnRlciBzb21ldGhpbmcgaW4geW91ciBicm93c2VyLCB5b3UgYXJlIG1ha2luZyBhIEdFVCByZXF1ZXN0LlxuXG5yb3V0ZXIuZ2V0KCcvcGhvdG8nLCBmdW5jdGlvbiBwaG90byhyZXEsIHJlcykge1xuICAgIHJlcy5zZW5kRmlsZShwYXRoICsgJy9wYWdlcy9waG90by5odG1sJyk7XG59KTtcblxucm91dGVyLmdldCgnL2FkbWluJywgZnVuY3Rpb24gYWRtaW4ocmVxLCByZXMpIHtcbiAgICByZXMuc2VuZEZpbGUocGF0aCArICcvcGFnZXMvYWRtaW4uaHRtbCcpO1xufSk7XG5cbnJvdXRlci5nZXQoJy9hcGkvaGF0JywgdXBsb2FkLmFueSgpLCBhc3luYyBmdW5jdGlvbiBoYXRHZXQocmVxLCByZXMpIHtcbiAgICBsZXQgYmFzZVVybCA9IG5ldyB1cmwuVVJMKFwiaHR0cDovL2dhdGV3YXktc2VydmljZTo4MC9oYXRtZVwiKTtcbiAgICBjb25zdCBudW1iZXIgPSByZXEucXVlcnkubnVtYmVyID8gcmVxLnF1ZXJ5Lm51bWJlciA6IFwiMVwiO1xuICAgIC8vbG9nZ2VyLmluZm8ocmVxLmJvZHkpO1xuICAgIGxldCB0eXBlID0gcmVxLmhlYWRlcnMudHlwZTtcbiAgICAvL2xvZ2dlci5pbmZvKHR5cGUpO1xuXG4gICAgaWYgKHR5cGUpIHtcbiAgICAgICAgYmFzZVVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKCdzdHlsZScsIHR5cGUpO1xuICAgIH1cblxuICAgIGJhc2VVcmwuc2VhcmNoUGFyYW1zLmFwcGVuZCgnbnVtYmVyJywgbnVtYmVyKTtcblxuXG4gICAgbG9nZ2VyLmluZm8oYEdFVCAke2Jhc2VVcmx9YCk7XG4gICAgbGV0IHJlc3AgPSBhd2FpdCBmZXRjaChiYXNlVXJsLnRvU3RyaW5nKCkpO1xuICAgIGxldCBkYXRhID0gYXdhaXQgcmVzcC5qc29uKCk7XG4gICAgLy9sb2dnZXIuaW5mbyhkYXRhKTtcbiAgICByZXMuc2VuZChkYXRhKTtcbn0pO1xuXG5yb3V0ZXIucG9zdCgnL2FwaS9oYXQnLCB1cGxvYWQuYW55KCksIGFzeW5jIGZ1bmN0aW9uIGhhdFBvc3QocmVxLCByZXMpIHtcbiAgICBsb2dnZXIuaW5mbyhcInBvc3RpbmcgY3VzdG9tIHBob3RvXCIpO1xuICAgIGxldCBiYXNlVXJsID0gbmV3IHVybC5VUkwoXCJodHRwOi8vZ2F0ZXdheS1zZXJ2aWNlOjgwL2hhdG1lXCIpO1xuICAgIGNvbnN0IG51bWJlciA9IHJlcS5xdWVyeS5udW1iZXIgPyByZXEucXVlcnkubnVtYmVyIDogXCIxXCI7XG5cbiAgICBsZXQgZmlsZSA9IHJlcS5maWxlc1swXS5idWZmZXI7XG5cbiAgICBsZXQgZm9ybURhdGEgPSBhd2FpdCBjcmVhdGVGb3JtKGZpbGUpO1xuICAgIGNvbnN0IGZvcm1IZWFkZXJzID0gYXdhaXQgZm9ybURhdGEuZ2V0SGVhZGVycygpO1xuICAgIGxldCB0eXBlID0gcmVxLmhlYWRlcnMudHlwZTtcbiAgICAvL2xvZ2dlci5pbmZvKGZpbGUpO1xuICAgIGxldCBvcHRpb25zID0ge1xuICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICBib2R5OiBmb3JtRGF0YSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgLi4uZm9ybUhlYWRlcnMsXG4gICAgICAgIH0sXG4gICAgfTtcblxuICAgIGlmICh0eXBlKSB7XG4gICAgICAgIGJhc2VVcmwuc2VhcmNoUGFyYW1zLmFwcGVuZCgnc3R5bGUnLCB0eXBlKTtcbiAgICB9XG5cbiAgICBiYXNlVXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoJ251bWJlcicsIG51bWJlcik7XG4gICAgbG9nZ2VyLmluZm8oYFBPU1QgJHtiYXNlVXJsfWApO1xuICAgIGxldCByZXNwID0gYXdhaXQgZmV0Y2goYmFzZVVybCwgb3B0aW9ucyk7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCByZXNwLmpzb24oKTtcbiAgICAvL2xvZ2dlci5pbmZvKGRhdGEpO1xuICAgIHJlcy5zZW5kKGRhdGEpO1xuXG59KTtcblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlRm9ybShmaWxlKSB7XG4gICAgbGV0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKClcbiAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCBmaWxlLCB7IGZpbGVuYW1lOiBcImZpbGVcIiwgZGF0YTogZmlsZSB9KVxuXG4gICAgcmV0dXJuIGZvcm1EYXRhXG59XG5cbnJvdXRlci5nZXQoJy9hcGkvbGlzdCcsIGFzeW5jIGZ1bmN0aW9uIGxpc3QocmVxLCByZXMpIHtcbiAgICBjb25zdCBiYXNlVXJsID0gXCJodHRwOi8vZ2F0ZXdheS1zZXJ2aWNlOjgwL2FwaS9oYXRzXCI7XG5cbiAgICBsb2dnZXIuaW5mbyhgR0VUICR7YmFzZVVybH1gKTtcbiAgICBjb25zdCByZXNwID0gYXdhaXQgZmV0Y2goYmFzZVVybCk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3AuanNvbigpO1xuICAgIHJlcy5zZW5kKGRhdGEpO1xufSk7XG5cblxucm91dGVyLmdldCgnL2FwaS9hZG1pbicsIGFzeW5jIGZ1bmN0aW9uIGFkbWluKHJlcSwgcmVzKSB7XG4gICAgbGV0IGJhc2VVcmwgPSBcImh0dHA6Ly9nYXRld2F5LXNlcnZpY2U6ODAvYWRtaW5cIlxuICAgIGxvZ2dlci5pbmZvKGBHRVQgJHtiYXNlVXJsfWApO1xuICAgIGxldCByZXNwID0gYXdhaXQgZmV0Y2goYmFzZVVybCk7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCByZXNwLmpzb24oKTtcbiAgICByZXMuc2VuZChkYXRhKTtcbn0pO1xuXG5yb3V0ZXIuZ2V0KCcvYXBpL2FkbWluL21vZGVyYXRlJywgYXN5bmMgZnVuY3Rpb24gbW9kZXJhdGUocmVxLCByZXMpIHtcbiAgICBsZXQgaWQgPSByZXEucXVlcnkuaWQ7XG4gICAgbGV0IGFwcHJvdmUgPSByZXEucXVlcnkuYXBwcm92ZTtcblxuICAgIGxldCBiYXNlVXJsID0gYGh0dHA6Ly9nYXRld2F5LXNlcnZpY2U6ODAvbW9kZXJhdGU/aWQ9JHtpZH0mYXBwcm92ZT0ke2FwcHJvdmV9YDtcblxuICAgIGxvZ2dlci5pbmZvKGBHRVQgJHtiYXNlVXJsfWApO1xuICAgIGxldCByZXNwID0gYXdhaXQgZmV0Y2goYmFzZVVybCk7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCByZXNwLmpzb24oKTtcbiAgICAvL2xvZ2dlci5pbmZvKGRhdGEpO1xuICAgIHJlcy5zZW5kKGRhdGEpO1xuXG59KTtcblxuYXBwLmxpc3Rlbihwcm9jZXNzLmVudi5QT1JUIHx8IDMwMDAsXG4gICAgKCkgPT4gbG9nZ2VyLmluZm8oXCJTZXJ2ZXIgaXMgcnVubmluZy4uLlwiKSk7Il19