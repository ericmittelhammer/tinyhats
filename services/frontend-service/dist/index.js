"use strict";

require('newrelic');

var express = require('express');

var app = express();
var router = express.Router();

var multer = require('multer');

const upload = multer();

var fetch = require('node-fetch');

var dirname = require('path').dirname;

var url = require('url');

var fileURLToPath = url.fileURLToPath;

var FormData = require('form-data');

const winston = require('winston');

const newrelicFormatter = require('@newrelic/winston-enricher');

const logger = winston.createLogger({
  level: 'info',
  transports: [new winston.transports.Console()],
  format: winston.format.combine(winston.format((info, opts) => Object.assign(info, {
    module: __filename
  }))(), newrelicFormatter(), winston.format.json())
}); // express is what helps us "route" the html pages. Usually on websites, you don't see /index.html. 
// Why? Because they use routing! When you navigate to /about, the web server with THIS code returns the HTML about.html page.

const dn = dirname(__filename);
app.set('view engine', 'ejs');
app.set('views', dn); // this is just setting up configuration for where all the files are.

const path = dn; //__dirname is the current directory we are in. Remember that every website literally has a computer running behind it!

app.use('/', router);
app.use('/assets', express.static(path + '/assets')); // this is telling the website WHERE all of our "asset" files are. Asset files include CSS for styling, JS for Bootstrap to make it pretty, and images.

router.get('/', function (req, res) {
  res.sendFile(path + '/pages/index.html');
}); // The logic here: when someone navigates to www.cybercatamounts.herokuapp.com, the website will return the content on the "index.html" page.
// Why is it router.get? Because when you enter something in your browser, you are making a GET request.

router.get('/photo', function (req, res) {
  res.sendFile(path + '/pages/photo.html');
});
router.get('/admin', function (req, res) {
  res.sendFile(path + '/pages/admin.html');
});
router.get('/api/hat', upload.any(), async function (req, res) {
  let baseUrl = new url.URL("http://gateway-service:80/hatme");
  const number = req.query.number ? req.query.number : "1"; //logger.info(req.body);

  let type = req.headers.type; //logger.info(type);

  if (type) {
    baseUrl.searchParams.append('style', type);
  }

  baseUrl.searchParams.append('number', number); //logger.info(baseUrl);

  let resp = await fetch(baseUrl.toString());
  let data = await resp.json(); //logger.info(data);

  res.send(data);
});
router.post('/api/hat', upload.any(), async function (req, res) {
  logger.info("posting custom photo");
  let baseUrl = new url.URL("http://gateway-service:80/hatme");
  const number = req.query.number ? req.query.number : "1";
  let file = req.files[0].buffer;
  let formData = await createForm(file);
  const formHeaders = await formData.getHeaders();
  let type = req.headers.type; //logger.info(file);

  let options = {
    method: "POST",
    body: formData,
    headers: { ...formHeaders
    }
  };

  if (type) {
    baseUrl.searchParams.append('style', type);
  }

  baseUrl.searchParams.append('number', number);
  logger.info(`posting to ${baseUrl}`);
  let resp = await fetch(baseUrl, options);
  let data = await resp.json(); //logger.info(data);

  res.send(data);
});

async function createForm(file) {
  let formData = new FormData();
  formData.append('file', file, {
    filename: "file",
    data: file
  });
  logger.info("Posting to Manipulate");
  return formData;
}

router.get('/api/list', async function (req, res) {
  const baseUrl = "http://gateway-service:80/api/hats";
  const resp = await fetch(baseUrl);
  const data = await resp.json();
  logger.info(data);
  res.send(data);
});
router.get('/api/admin', async function (req, res) {
  let baseUrl = "http://gateway-service:80/admin";
  let resp = await fetch(baseUrl);
  let data = await resp.json();
  res.send(data);
});
router.get('/api/admin/moderate', async function (req, res) {
  let id = req.query.id;
  let approve = req.query.approve;
  let baseUrl = `http://gateway-service:80/moderate?id=${id}&approve=${approve}`;
  let resp = await fetch(baseUrl);
  let data = await resp.json();
  logger.info(data);
  res.send(data);
});
app.listen(process.env.PORT || 3000, () => logger.info("Server is running..."));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbInJlcXVpcmUiLCJleHByZXNzIiwiYXBwIiwicm91dGVyIiwiUm91dGVyIiwibXVsdGVyIiwidXBsb2FkIiwiZmV0Y2giLCJkaXJuYW1lIiwidXJsIiwiZmlsZVVSTFRvUGF0aCIsIkZvcm1EYXRhIiwid2luc3RvbiIsIm5ld3JlbGljRm9ybWF0dGVyIiwibG9nZ2VyIiwiY3JlYXRlTG9nZ2VyIiwibGV2ZWwiLCJ0cmFuc3BvcnRzIiwiQ29uc29sZSIsImZvcm1hdCIsImNvbWJpbmUiLCJpbmZvIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsIm1vZHVsZSIsIl9fZmlsZW5hbWUiLCJqc29uIiwiZG4iLCJzZXQiLCJwYXRoIiwidXNlIiwic3RhdGljIiwiZ2V0IiwicmVxIiwicmVzIiwic2VuZEZpbGUiLCJhbnkiLCJiYXNlVXJsIiwiVVJMIiwibnVtYmVyIiwicXVlcnkiLCJ0eXBlIiwiaGVhZGVycyIsInNlYXJjaFBhcmFtcyIsImFwcGVuZCIsInJlc3AiLCJ0b1N0cmluZyIsImRhdGEiLCJzZW5kIiwicG9zdCIsImZpbGUiLCJmaWxlcyIsImJ1ZmZlciIsImZvcm1EYXRhIiwiY3JlYXRlRm9ybSIsImZvcm1IZWFkZXJzIiwiZ2V0SGVhZGVycyIsIm9wdGlvbnMiLCJtZXRob2QiLCJib2R5IiwiZmlsZW5hbWUiLCJpZCIsImFwcHJvdmUiLCJsaXN0ZW4iLCJwcm9jZXNzIiwiZW52IiwiUE9SVCJdLCJtYXBwaW5ncyI6Ijs7QUFBQUEsT0FBTyxDQUFDLFVBQUQsQ0FBUDs7QUFDQSxJQUFJQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxTQUFELENBQXJCOztBQUNBLElBQUlFLEdBQUcsR0FBR0QsT0FBTyxFQUFqQjtBQUNBLElBQUlFLE1BQU0sR0FBR0YsT0FBTyxDQUFDRyxNQUFSLEVBQWI7O0FBQ0EsSUFBSUMsTUFBTSxHQUFHTCxPQUFPLENBQUMsUUFBRCxDQUFwQjs7QUFDQSxNQUFNTSxNQUFNLEdBQUdELE1BQU0s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LEVBQ0ksTUFBTXJELE1BQU0sQ0FBQ08sSUFBUCxDQUFZLHNCQUFaLENBRFYiLCJzb3VyY2VzQ29udGVudCI6WyJyZXF1aXJlKCduZXdyZWxpYycpXG52YXIgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbnZhciBhcHAgPSBleHByZXNzKCk7XG52YXIgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbnZhciBtdWx0ZXIgPSByZXF1aXJlKCdtdWx0ZXInKTtcbmNvbnN0IHVwbG9hZCA9IG11bHRlcigpO1xudmFyIGZldGNoID0gcmVxdWlyZSgnbm9kZS1mZXRjaCcpO1xudmFyIGRpcm5hbWUgPSByZXF1aXJlKCdwYXRoJykuZGlybmFtZTtcbnZhciB1cmwgPSByZXF1aXJlKCd1cmwnKTtcbnZhciBmaWxlVVJMVG9QYXRoID0gdXJsLmZpbGVVUkxUb1BhdGg7XG52YXIgRm9ybURhdGEgPSByZXF1aXJlKCdmb3JtLWRhdGEnKVxuXG5jb25zdCB3aW5zdG9uID0gcmVxdWlyZSgnd2luc3RvbicpO1xuY29uc3QgbmV3cmVsaWNGb3JtYXR0ZXIgPSByZXF1aXJlKCdAbmV3cmVsaWMvd2luc3Rvbi1lbnJpY2hlcicpO1xuXG5cbmNvbnN0IGxvZ2dlciA9IHdpbnN0b24uY3JlYXRlTG9nZ2VyKHtcbiAgICBsZXZlbDogJ2luZm8nLFxuICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSgpXG4gICAgXSxcbiAgICBmb3JtYXQ6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUoXG4gICAgICAgIHdpbnN0b24uZm9ybWF0KChpbmZvLCBvcHRzKSA9PiBPYmplY3QuYXNzaWduKGluZm8sIHttb2R1bGU6IF9fZmlsZW5hbWV9KSkoKSxcbiAgICAgICAgbmV3cmVsaWNGb3JtYXR0ZXIoKSxcbiAgICAgICAgd2luc3Rvbi5mb3JtYXQuanNvbigpXG4gICAgKVxuICB9KTtcblxuLy8gZXhwcmVzcyBpcyB3aGF0IGhlbHBzIHVzIFwicm91dGVcIiB0aGUgaHRtbCBwYWdlcy4gVXN1YWxseSBvbiB3ZWJzaXRlcywgeW91IGRvbid0IHNlZSAvaW5kZXguaHRtbC4gXG4vLyBXaHk/IEJlY2F1c2UgdGhleSB1c2Ugcm91dGluZyEgV2hlbiB5b3UgbmF2aWdhdGUgdG8gL2Fib3V0LCB0aGUgd2ViIHNlcnZlciB3aXRoIFRISVMgY29kZSByZXR1cm5zIHRoZSBIVE1MIGFib3V0Lmh0bWwgcGFnZS5cblxuY29uc3QgZG4gPSBkaXJuYW1lKF9fZmlsZW5hbWUpO1xuYXBwLnNldCgndmlldyBlbmdpbmUnLCAnZWpzJyk7XG5hcHAuc2V0KCd2aWV3cycsIGRuKTtcblxuLy8gdGhpcyBpcyBqdXN0IHNldHRpbmcgdXAgY29uZmlndXJhdGlvbiBmb3Igd2hlcmUgYWxsIHRoZSBmaWxlcyBhcmUuXG5jb25zdCBwYXRoID0gZG47XG5cbi8vX19kaXJuYW1lIGlzIHRoZSBjdXJyZW50IGRpcmVjdG9yeSB3ZSBhcmUgaW4uIFJlbWVtYmVyIHRoYXQgZXZlcnkgd2Vic2l0ZSBsaXRlcmFsbHkgaGFzIGEgY29tcHV0ZXIgcnVubmluZyBiZWhpbmQgaXQhXG5hcHAudXNlKCcvJywgcm91dGVyKTtcbmFwcC51c2UoJy9hc3NldHMnLCBleHByZXNzLnN0YXRpYyhwYXRoICsgJy9hc3NldHMnKSlcblxuLy8gdGhpcyBpcyB0ZWxsaW5nIHRoZSB3ZWJzaXRlIFdIRVJFIGFsbCBvZiBvdXIgXCJhc3NldFwiIGZpbGVzIGFyZS4gQXNzZXQgZmlsZXMgaW5jbHVkZSBDU1MgZm9yIHN0eWxpbmcsIEpTIGZvciBCb290c3RyYXAgdG8gbWFrZSBpdCBwcmV0dHksIGFuZCBpbWFnZXMuXG5cbnJvdXRlci5nZXQoJy8nLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICByZXMuc2VuZEZpbGUocGF0aCArICcvcGFnZXMvaW5kZXguaHRtbCcpO1xufSk7XG5cbi8vIFRoZSBsb2dpYyBoZXJlOiB3aGVuIHNvbWVvbmUgbmF2aWdhdGVzIHRvIHd3dy5jeWJlcmNhdGFtb3VudHMuaGVyb2t1YXBwLmNvbSwgdGhlIHdlYnNpdGUgd2lsbCByZXR1cm4gdGhlIGNvbnRlbnQgb24gdGhlIFwiaW5kZXguaHRtbFwiIHBhZ2UuXG4vLyBXaHkgaXMgaXQgcm91dGVyLmdldD8gQmVjYXVzZSB3aGVuIHlvdSBlbnRlciBzb21ldGhpbmcgaW4geW91ciBicm93c2VyLCB5b3UgYXJlIG1ha2luZyBhIEdFVCByZXF1ZXN0LlxuXG5yb3V0ZXIuZ2V0KCcvcGhvdG8nLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICByZXMuc2VuZEZpbGUocGF0aCArICcvcGFnZXMvcGhvdG8uaHRtbCcpO1xufSk7XG5cbnJvdXRlci5nZXQoJy9hZG1pbicsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIHJlcy5zZW5kRmlsZShwYXRoICsgJy9wYWdlcy9hZG1pbi5odG1sJyk7XG59KTtcblxucm91dGVyLmdldCgnL2FwaS9oYXQnLCB1cGxvYWQuYW55KCksIGFzeW5jIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIGxldCBiYXNlVXJsID0gbmV3IHVybC5VUkwoXCJodHRwOi8vZ2F0ZXdheS1zZXJ2aWNlOjgwL2hhdG1lXCIpO1xuICAgIGNvbnN0IG51bWJlciA9IHJlcS5xdWVyeS5udW1iZXIgPyByZXEucXVlcnkubnVtYmVyIDogXCIxXCI7XG4gICAgLy9sb2dnZXIuaW5mbyhyZXEuYm9keSk7XG4gICAgbGV0IHR5cGUgPSByZXEuaGVhZGVycy50eXBlO1xuICAgIC8vbG9nZ2VyLmluZm8odHlwZSk7XG5cbiAgICBpZiAodHlwZSkge1xuICAgICAgICBiYXNlVXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoJ3N0eWxlJywgdHlwZSk7XG4gICAgfVxuXG4gICAgYmFzZVVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKCdudW1iZXInLCBudW1iZXIpO1xuXG5cbiAgICAvL2xvZ2dlci5pbmZvKGJhc2VVcmwpO1xuICAgIGxldCByZXNwID0gYXdhaXQgZmV0Y2goYmFzZVVybC50b1N0cmluZygpKTtcbiAgICBsZXQgZGF0YSA9IGF3YWl0IHJlc3AuanNvbigpO1xuICAgIC8vbG9nZ2VyLmluZm8oZGF0YSk7XG4gICAgcmVzLnNlbmQoZGF0YSk7XG59KTtcblxucm91dGVyLnBvc3QoJy9hcGkvaGF0JywgdXBsb2FkLmFueSgpLCBhc3luYyBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICBsb2dnZXIuaW5mbyhcInBvc3RpbmcgY3VzdG9tIHBob3RvXCIpO1xuICAgIGxldCBiYXNlVXJsID0gbmV3IHVybC5VUkwoXCJodHRwOi8vZ2F0ZXdheS1zZXJ2aWNlOjgwL2hhdG1lXCIpO1xuICAgIGNvbnN0IG51bWJlciA9IHJlcS5xdWVyeS5udW1iZXIgPyByZXEucXVlcnkubnVtYmVyIDogXCIxXCI7XG5cbiAgICBsZXQgZmlsZSA9IHJlcS5maWxlc1swXS5idWZmZXI7XG5cbiAgICBsZXQgZm9ybURhdGEgPSBhd2FpdCBjcmVhdGVGb3JtKGZpbGUpO1xuICAgIGNvbnN0IGZvcm1IZWFkZXJzID0gYXdhaXQgZm9ybURhdGEuZ2V0SGVhZGVycygpO1xuICAgIGxldCB0eXBlID0gcmVxLmhlYWRlcnMudHlwZTtcbiAgICAvL2xvZ2dlci5pbmZvKGZpbGUpO1xuICAgIGxldCBvcHRpb25zID0ge1xuICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICBib2R5OiBmb3JtRGF0YSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgLi4uZm9ybUhlYWRlcnMsXG4gICAgICAgIH0sXG4gICAgfTtcblxuICAgIGlmICh0eXBlKSB7XG4gICAgICAgIGJhc2VVcmwuc2VhcmNoUGFyYW1zLmFwcGVuZCgnc3R5bGUnLCB0eXBlKTtcbiAgICB9XG5cbiAgICBiYXNlVXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoJ251bWJlcicsIG51bWJlcik7XG4gICAgbG9nZ2VyLmluZm8oYHBvc3RpbmcgdG8gJHtiYXNlVXJsfWApO1xuICAgIGxldCByZXNwID0gYXdhaXQgZmV0Y2goYmFzZVVybCwgb3B0aW9ucyk7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCByZXNwLmpzb24oKTtcbiAgICAvL2xvZ2dlci5pbmZvKGRhdGEpO1xuICAgIHJlcy5zZW5kKGRhdGEpO1xuXG59KTtcblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlRm9ybShmaWxlKSB7XG4gICAgbGV0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKClcbiAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCBmaWxlLCB7IGZpbGVuYW1lOiBcImZpbGVcIiwgZGF0YTogZmlsZSB9KVxuICAgIGxvZ2dlci5pbmZvKFwiUG9zdGluZyB0byBNYW5pcHVsYXRlXCIpXG5cbiAgICByZXR1cm4gZm9ybURhdGFcbn1cblxucm91dGVyLmdldCgnL2FwaS9saXN0JywgYXN5bmMgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgY29uc3QgYmFzZVVybCA9IFwiaHR0cDovL2dhdGV3YXktc2VydmljZTo4MC9hcGkvaGF0c1wiO1xuXG4gICAgY29uc3QgcmVzcCA9IGF3YWl0IGZldGNoKGJhc2VVcmwpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwLmpzb24oKTtcbiAgICBsb2dnZXIuaW5mbyhkYXRhKTtcbiAgICByZXMuc2VuZChkYXRhKTtcbn0pO1xuXG5cbnJvdXRlci5nZXQoJy9hcGkvYWRtaW4nLCBhc3luYyBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICBsZXQgYmFzZVVybCA9IFwiaHR0cDovL2dhdGV3YXktc2VydmljZTo4MC9hZG1pblwiXG4gICAgbGV0IHJlc3AgPSBhd2FpdCBmZXRjaChiYXNlVXJsKTtcbiAgICBsZXQgZGF0YSA9IGF3YWl0IHJlc3AuanNvbigpO1xuICAgIHJlcy5zZW5kKGRhdGEpO1xufSk7XG5cbnJvdXRlci5nZXQoJy9hcGkvYWRtaW4vbW9kZXJhdGUnLCBhc3luYyBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICBsZXQgaWQgPSByZXEucXVlcnkuaWQ7XG4gICAgbGV0IGFwcHJvdmUgPSByZXEucXVlcnkuYXBwcm92ZTtcblxuICAgIGxldCBiYXNlVXJsID0gYGh0dHA6Ly9nYXRld2F5LXNlcnZpY2U6ODAvbW9kZXJhdGU/aWQ9JHtpZH0mYXBwcm92ZT0ke2FwcHJvdmV9YDtcblxuICAgIGxldCByZXNwID0gYXdhaXQgZmV0Y2goYmFzZVVybCk7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCByZXNwLmpzb24oKTtcbiAgICBsb2dnZXIuaW5mbyhkYXRhKTtcbiAgICByZXMuc2VuZChkYXRhKTtcblxufSk7XG5cbmFwcC5saXN0ZW4ocHJvY2Vzcy5lbnYuUE9SVCB8fCAzMDAwLFxuICAgICgpID0+IGxvZ2dlci5pbmZvKFwiU2VydmVyIGlzIHJ1bm5pbmcuLi5cIikpOyJdfQ==